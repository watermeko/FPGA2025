# 资源优化记录

## 问题
编译时遇到资源超限和布线失败：
- 逻辑资源: 23707 > 23040 (超出667个)
- 布线失败: 844个网络无法布线

## 优化措施

### 第一轮优化（针对逻辑资源）
1. **Packer缓冲区**: 256字节 → 64字节
   - 每通道节省: 192 × 8 = 1536 bits
   - 3通道总计: 4608 bits

2. **Arbiter FIFO深度**: 128 → 64
   - 每FIFO节省: 64 × 9 = 576 bits
   - 3 FIFO总计: 1728 bits

### 第二轮优化（针对布线失败）
1. **Packer缓冲区**: 64字节 → **32字节**
   - 每通道节省: 32 × 8 = 256 bits
   - 3通道总计: 768 bits

2. **Arbiter FIFO深度**: 64 → **32**
   - 每FIFO节省: 32 × 9 = 288 bits
   - 3 FIFO总计: 864 bits

## 总计节省资源
- **Packer**: (256-32) × 3 × 8 = **5376 bits**
- **Arbiter**: (128-32) × 3 × 9 = **2592 bits**
- **合计**: 约 **7968 bits** 寄存器

## 功能影响评估

### ✅ 仍然足够使用
- **DSM**: 最大9字节/通道，32字节缓冲区绰绰有余
- **SPI**: 一般读写不超过32字节
- **UART**: 小数据包（<32字节）无影响

### ⚠️ 可能受影响的场景
- 大于32字节的连续上传数据包
- 解决方案：分多次上传，packer会自动处理

## 当前配置
```verilog
// upload_packer_0.v
reg [7:0] data_buffer [0:NUM_CHANNELS-1][0:31];  // 32字节缓冲

// cdc.v
upload_arbiter #(
    .NUM_SOURCES(3),
    .FIFO_DEPTH(32)  // 32深度FIFO
)
```

## 如果还是失败
可以考虑：
1. 减小到16字节缓冲区（不推荐，DSM需要9字节）
2. 减小FIFO到16深度
3. 移除某个不常用的功能模块
4. 使用BRAM代替寄存器实现FIFO

## 建议
当前配置（32字节缓冲 + 32深度FIFO）是平衡点：
- 资源占用合理
- 功能基本不受影响
- 适合大部分应用场景
