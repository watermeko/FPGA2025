# ç‰ˆæœ¬å¯¹æ¯”ï¼šV0 vs æœ€æ–°ç‰ˆ

## æ¦‚è¿°

æœ¬æ–‡æ¡£å¯¹æ¯”ä¸¤ä¸ªç‰ˆæœ¬çš„é›†æˆæµ‹è¯•ï¼Œå¸®åŠ©ç†è§£æ¨¡å—çš„æ¼”è¿›è¿‡ç¨‹å’ŒBugä¿®å¤ã€‚

---

## ğŸ“‚ ä¸¤ä¸ªä»¿çœŸç¯å¢ƒ

| é¡¹ç›® | Version 0 | æœ€æ–°ç‰ˆ |
|------|-----------|--------|
| **ç›®å½•** | `sim/upload_full_integration_v0_tb/` | `sim/upload_full_integration_tb/` |
| **Testbench** | `upload_full_integration_v0_tb.v` | `upload_full_integration_tb.v` |
| **æ¨¡å—** | `*_0.v` (å¸¦0ç‰ˆæœ¬) | `*.v` (ä¸å¸¦0ç‰ˆæœ¬) |
| **çŠ¶æ€** | æœ‰Bugçš„æ—§ç‰ˆæœ¬ | ä¿®å¤åçš„æœ€æ–°ç‰ˆæœ¬ |

---

## ğŸ” æ ¸å¿ƒå·®å¼‚å¯¹æ¯”

### 1. upload_arbiterå·®å¼‚

#### **ä¼˜å…ˆçº§é€»è¾‘**

| ç‰ˆæœ¬ | ä»£ç  | ç»“æœ |
|------|------|------|
| **V0** | `assign next_source = fifo_has_data[1] ? 2'd1 : 2'd0;` | **SPI > UART** âŒ |
| **æœ€æ–°** | `assign next_source = fifo_has_data[0] ? 2'd0 : 2'd1;` | **UART > SPI** âœ… |

**Bugè¯´æ˜**ï¼š
- V0æ³¨é‡Šè¯´"UART > SPI"ï¼Œä½†å®é™…ä»£ç å®ç°äº†"SPI > UART"
- è¿™æ˜¯æ³¨é‡Šä¸ä»£ç ä¸ä¸€è‡´çš„ç»å…¸Bug

#### **FIFOè¯»ä½¿èƒ½æ§åˆ¶**

| ç‰ˆæœ¬ | å®ç°æ–¹å¼ | å¤æ‚åº¦ |
|------|----------|--------|
| **V0** | ä½¿ç”¨ `reg fifo_rd_en_ctrl[NUM_SOURCES-1:0]` ä½œä¸ºä¸­é—´ä¿¡å· | é«˜ |
| **æœ€æ–°** | ç›´æ¥æ“ä½œ `reg fifo_rd_en` (generateå—å†…) | ä½ |

**ä»£ç å¯¹æ¯”**ï¼š

```verilog
// ========== V0ç‰ˆæœ¬ ==========
// ç¬¬43è¡Œï¼šå¼•å…¥ä¸­é—´æ§åˆ¶ä¿¡å·
reg [NUM_SOURCES-1:0] fifo_rd_en_ctrl;

// ç¬¬67è¡Œï¼šwireç±»å‹ï¼Œä»å¤–éƒ¨æ§åˆ¶
wire fifo_rd_en;
assign fifo_rd_en = fifo_rd_en_ctrl[i];

// ç¬¬170è¡Œï¼šé€šè¿‡ä¸­é—´ä¿¡å·æ§åˆ¶
fifo_rd_en_ctrl[next_source] <= 1'b1;


// ========== æœ€æ–°ç‰ˆæœ¬ ==========
// ç¬¬64è¡Œï¼šç›´æ¥å£°æ˜ä¸ºreg
reg  fifo_rd_en;

// ç¬¬169è¡Œï¼šç›´æ¥æ“ä½œ
gen_fifos[0].fifo_rd_en <= 1'b1;
```

**åŸå› **ï¼š
- V0ï¼šè§„é¿æ—§ç‰ˆç»¼åˆå·¥å…·çš„è·¨generateå—èµ‹å€¼é™åˆ¶
- æœ€æ–°ï¼šç°ä»£ç»¼åˆå·¥å…·å·²æ”¯æŒï¼Œä»£ç æ›´ç®€æ´

---

### 2. upload_packerå·®å¼‚

| å·®å¼‚é¡¹ | V0 | æœ€æ–°ç‰ˆ |
|--------|-----|--------|
| **æ–‡ä»¶å¤§å°** | 9.8KB | 10KB |
| **ä¿®æ”¹æ—¶é—´** | 2025-10-06 23:28 | 2025-10-07 05:09 |
| **ä¸»è¦å·®å¼‚** | å¯èƒ½å­˜åœ¨æ—¶åºBug | ä¼˜åŒ–åç‰ˆæœ¬ |

**æ³¨**ï¼šå·®å¼‚ä¸å¤§ï¼Œä¸»è¦æ˜¯ç»†èŠ‚ä¼˜åŒ–ã€‚

---

### 3. upload_adapter

| ç‰ˆæœ¬ | æ–‡ä»¶ | çŠ¶æ€ |
|------|------|------|
| **V0** | `upload_adapter_0.v` | å”¯ä¸€ç‰ˆæœ¬ |
| **æœ€æ–°** | ï¼ˆåŒV0ï¼‰ | æ— æ”¹åŠ¨ |

**è¯´æ˜**ï¼šadapteræ¨¡å—åªæœ‰ä¸€ä¸ªç‰ˆæœ¬ï¼Œä¸¤ä¸ªä»¿çœŸéƒ½ä½¿ç”¨ç›¸åŒæ–‡ä»¶ã€‚

---

## ğŸ§ª æµ‹è¯•ç»“æœå¯¹æ¯”

### Test 1 & 2: å•ç‹¬å‘é€

| æµ‹è¯• | V0 | æœ€æ–°ç‰ˆ |
|------|-----|--------|
| UARTå•å‘ | âœ… PASS | âœ… PASS |
| SPIå•å‘ | âœ… PASS | âœ… PASS |

**ç»“è®º**ï¼šä¸¤ä¸ªç‰ˆæœ¬åœ¨åŸºæœ¬åŠŸèƒ½ä¸Šæ— å·®å¼‚ã€‚

---

### Test 3: å¹¶å‘å‘é€ï¼ˆå…³é”®ï¼‰

| é¡¹ç›® | V0 | æœ€æ–°ç‰ˆ |
|------|-----|--------|
| **ä¼˜å…ˆçº§** | SPIå…ˆè¢«æœåŠ¡ âŒ | UARTå…ˆè¢«æœåŠ¡ âœ… |
| **æ•°æ®å®Œæ•´æ€§** | âœ… åŒ…ä¸è¢«æ‰“æ–­ | âœ… åŒ…ä¸è¢«æ‰“æ–­ |
| **å­—èŠ‚æ•°** | 20å­—èŠ‚ | 20å­—èŠ‚ |

**æ³¢å½¢å¯¹æ¯”**ï¼š

**V0ç‰ˆæœ¬**ï¼š
```
Time: 100ns  - SPIå¼€å§‹å‘é€ï¼ˆå…ˆæœåŠ¡ï¼‰
Time: 500ns  - SPIæ•°æ®åŒ…å®Œæˆ
Time: 510ns  - UARTå¼€å§‹å‘é€ï¼ˆåæœåŠ¡ï¼‰
```

**æœ€æ–°ç‰ˆæœ¬**ï¼š
```
Time: 100ns  - UARTå¼€å§‹å‘é€ï¼ˆå…ˆæœåŠ¡ï¼‰âœ“
Time: 400ns  - UARTæ•°æ®åŒ…å®Œæˆ
Time: 410ns  - SPIå¼€å§‹å‘é€ï¼ˆåæœåŠ¡ï¼‰
```

**ç»“è®º**ï¼šV0çš„ä¼˜å…ˆçº§Bugåœ¨Test 3ä¸­è¢«æ˜ç¡®è§‚å¯Ÿåˆ°ã€‚

---

### Test 4 & 5: èƒŒå‹å’Œäº¤æ›¿

| æµ‹è¯• | V0 | æœ€æ–°ç‰ˆ |
|------|-----|--------|
| èƒŒå‹æµ‹è¯• | âœ… PASS | âœ… PASS |
| äº¤æ›¿å‘é€ | âœ… PASS | âœ… PASS |

**ç»“è®º**ï¼šFIFOå’Œæ¡æ‰‹æœºåˆ¶åœ¨ä¸¤ä¸ªç‰ˆæœ¬ä¸­éƒ½å·¥ä½œæ­£å¸¸ã€‚

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

| æŒ‡æ ‡ | V0 | æœ€æ–°ç‰ˆ |
|------|-----|--------|
| **ç¼–è¯‘æ—¶é—´** | ç›¸åŒ | ç›¸åŒ |
| **èµ„æºä½¿ç”¨** | ç•¥é«˜ï¼ˆå¤šä¸€å±‚æ§åˆ¶ï¼‰ | ç•¥ä½ |
| **ä»£ç è¡Œæ•°** | arbiter_0: 253è¡Œ | arbiter: 254è¡Œ |
| **å¯ç»´æŠ¤æ€§** | ä¸­ç­‰ï¼ˆéœ€ç†è§£ä¸­é—´å±‚ï¼‰ | å¥½ï¼ˆé€»è¾‘ç›´è§‚ï¼‰ |

---

## ğŸ› å·²çŸ¥Bugæ€»ç»“

### V0ç‰ˆæœ¬é—®é¢˜

1. **ä¼˜å…ˆçº§åè½¬**ï¼ˆä¸¥é‡ï¼‰âš ï¸
   - æ³¨é‡Šè¯´UARTä¼˜å…ˆ
   - å®é™…ä»£ç SPIä¼˜å…ˆ
   - å½±å“ï¼šå®æ—¶UARTæ•°æ®è¢«å»¶è¿Ÿ

2. **ä»£ç å†—ä½™**ï¼ˆä¸­ç­‰ï¼‰
   - éœ€è¦é¢å¤–çš„`fifo_rd_en_ctrl`ä¿¡å·
   - å¢åŠ ç»´æŠ¤å¤æ‚åº¦

3. **æ³¨é‡Šä¸ä¸€è‡´**ï¼ˆè½»å¾®ï¼‰
   - æ–‡æ¡£ä¸å®ç°çŸ›ç›¾
   - æ˜“è¯¯å¯¼å¼€å‘è€…

### æœ€æ–°ç‰ˆæœ¬ä¿®å¤

âœ… ä¼˜å…ˆçº§æ­£ç¡®ï¼ˆUART > SPIï¼‰
âœ… ä»£ç ç®€åŒ–ï¼ˆç›´æ¥æ“ä½œï¼‰
âœ… æ³¨é‡Šä¸€è‡´

---

## ğŸ¯ å¦‚ä½•è¿è¡Œå¯¹æ¯”æµ‹è¯•

### æ–¹æ³•1ï¼šé¡ºåºè¿è¡Œ

```bash
# è¿è¡ŒV0ç‰ˆæœ¬
cd sim/upload_full_integration_v0_tb
./run_sim.bat

# è¿è¡Œæœ€æ–°ç‰ˆæœ¬
cd ../upload_full_integration_tb
./run_sim.bat
```

### æ–¹æ³•2ï¼šå¹¶è¡Œå¯¹æ¯”

```bash
# ç»ˆç«¯1
cd sim/upload_full_integration_v0_tb
vsim -do cmd.do

# ç»ˆç«¯2
cd sim/upload_full_integration_tb
vsim -do cmd.do
```

### æ–¹æ³•3ï¼šæ³¢å½¢å¯¹æ¯”

1. è¿è¡Œä¸¤ä¸ªä»¿çœŸ
2. æ‰“å¼€ä¸¤ä¸ªæ³¢å½¢æ–‡ä»¶ï¼š
   - `upload_full_integration_v0_tb.vcd`
   - `upload_full_integration_tb.vcd`
3. å¯¹æ¯”Test 3çš„æ³¢å½¢æ—¶åº

---

## ğŸ“ˆ å…³é”®è§‚å¯Ÿä¿¡å·

### ä¼˜å…ˆçº§Bugè§‚å¯Ÿ

åœ¨Test 3å¹¶å‘æµ‹è¯•ä¸­ï¼Œè§‚å¯Ÿè¿™äº›ä¿¡å·ï¼š

| ä¿¡å· | V0æœŸæœ›å€¼ | æœ€æ–°ç‰ˆæœŸæœ›å€¼ |
|------|----------|--------------|
| `next_source` | å…ˆ2'd1(SPI) | å…ˆ2'd0(UART) |
| `current_source` | å…ˆåˆ‡åˆ°1 | å…ˆåˆ‡åˆ°0 |
| `merged_source` | å…ˆ0x03 | å…ˆ0x01 |
| `first_concurrent_source` | 0x03 | 0x01 |

### æ§åˆ¶ä¿¡å·è§‚å¯Ÿ

| ä¿¡å· | V0 | æœ€æ–°ç‰ˆ |
|------|-----|--------|
| `fifo_rd_en_ctrl` | å­˜åœ¨ï¼ˆ2ä½å‘é‡ï¼‰ | ä¸å­˜åœ¨ |
| `fifo_rd_en` | wireç±»å‹ | regç±»å‹ |

---

## ğŸ’¡ å­¦ä¹ è¦ç‚¹

### ä»Bugä¸­å­¦åˆ°ä»€ä¹ˆ

1. **æ³¨é‡Šä¸ä»£ç å¿…é¡»ä¸€è‡´**
   - V0çš„æ³¨é‡Šè¯´UARTä¼˜å…ˆï¼Œä»£ç å´æ˜¯SPIä¼˜å…ˆ
   - å¯¼è‡´ç»´æŠ¤å›°éš¾å’ŒBugéšè—

2. **ä¼˜å…ˆçº§é€»è¾‘è¦æ¸…æ™°**
   ```verilog
   // é”™è¯¯ç¤ºä¾‹ï¼ˆV0ï¼‰ï¼šæ£€æŸ¥é«˜ç´¢å¼•ä¼˜å…ˆ
   assign next_source = fifo_has_data[1] ? 2'd1 : 2'd0;

   // æ­£ç¡®ç¤ºä¾‹ï¼ˆæœ€æ–°ï¼‰ï¼šæ£€æŸ¥ä½ç´¢å¼•ä¼˜å…ˆ
   assign next_source = fifo_has_data[0] ? 2'd0 : 2'd1;
   ```

3. **å·¥å…·å…¼å®¹æ€§æ¼”è¿›**
   - V0éœ€è¦workaroundè§„é¿ç»¼åˆé™åˆ¶
   - æœ€æ–°ç‰ˆç›´æ¥åˆ©ç”¨ç°ä»£å·¥å…·ç‰¹æ€§

### ç‰ˆæœ¬æ¼”è¿›çš„å¯ç¤º

```
V0 (æ—§ç‰ˆæœ¬)           æœ€æ–°ç‰ˆ (ä¿®å¤ç‰ˆ)
    â†“                      â†“
å‘ç°Bug        â†’      ä¿®å¤ä¼˜å…ˆçº§
    â†“                      â†“
å·¥å…·å…¼å®¹       â†’      ç®€åŒ–ä»£ç 
    â†“                      â†“
æ–‡æ¡£æ›´æ–°       â†’      æ³¨é‡Šä¸€è‡´
```

---

## ğŸ”— ç›¸å…³æ–‡ä»¶

### V0ç‰ˆæœ¬
- Testbench: `tb/upload_full_integration_v0_tb.v`
- ä»¿çœŸè„šæœ¬: `sim/upload_full_integration_v0_tb/cmd.do`
- æ¨¡å—: `rtl/upload_adapter_0.v`, `rtl/upload_packer_0.v`, `rtl/upload_arbiter_0.v`

### æœ€æ–°ç‰ˆæœ¬
- Testbench: `tb/upload_full_integration_tb.v`
- ä»¿çœŸè„šæœ¬: `sim/upload_full_integration_tb/cmd.do`
- æ¨¡å—: `rtl/upload_adapter_0.v`, `rtl/upload_packer.v`, `rtl/upload_arbiter.v`

---

## ğŸ“ æ¨èå®éªŒ

### å®éªŒ1ï¼šè§‚å¯Ÿä¼˜å…ˆçº§Bug
1. è¿è¡ŒV0ä»¿çœŸ
2. åœ¨Test 3ä¸­æš‚åœ
3. æŸ¥çœ‹`next_source`ä¿¡å·
4. ç¡®è®¤SPIè¢«ä¼˜å…ˆæœåŠ¡

### å®éªŒ2ï¼šå¯¹æ¯”æ³¢å½¢
1. åŒæ—¶æ‰“å¼€ä¸¤ä¸ªæ³¢å½¢
2. å¯¹é½æ—¶é—´è½´åˆ°Test 3å¼€å§‹
3. å¯¹æ¯”`current_source`çš„åˆ‡æ¢æ—¶åº

### å®éªŒ3ï¼šä¿®æ”¹ä»£ç éªŒè¯
åœ¨V0ä¸­ä¿®æ”¹ç¬¬142è¡Œï¼š
```verilog
// åŸå§‹ï¼ˆBugï¼‰
assign next_source = fifo_has_data[1] ? 2'd1 : 2'd0;

// ä¿®æ”¹ä¸º
assign next_source = fifo_has_data[0] ? 2'd0 : 2'd1;
```
é‡æ–°ä»¿çœŸï¼Œè§‚å¯ŸTest 3æ˜¯å¦å˜æ­£ç¡®ã€‚

---

## âœ… éªŒæ”¶æ ‡å‡†

### V0ç‰ˆæœ¬é¢„æœŸç»“æœ

âœ… Test 1-2 PASSï¼ˆåŸºæœ¬åŠŸèƒ½æ­£å¸¸ï¼‰
âš ï¸ Test 3 æ˜¾ç¤ºSPIä¼˜å…ˆï¼ˆBugç‰¹å¾ï¼‰
âœ… Test 4-5 PASSï¼ˆå…¶ä»–åŠŸèƒ½æ­£å¸¸ï¼‰
âš ï¸ ç»ˆç«¯è¾“å‡ºæ˜¾ç¤º"SPI served first (0x03) - Bug confirmed!"

### æœ€æ–°ç‰ˆæœ¬é¢„æœŸç»“æœ

âœ… æ‰€æœ‰Test PASS
âœ… Test 3 æ˜¾ç¤ºUARTä¼˜å…ˆ
âœ… ç»ˆç«¯è¾“å‡ºæ— Bugè­¦å‘Š

---

## ğŸ“ æ€»ç»“

| ç»´åº¦ | V0è¯„åˆ† | æœ€æ–°ç‰ˆè¯„åˆ† |
|------|--------|-----------|
| **åŠŸèƒ½æ­£ç¡®æ€§** | 7/10 (ä¼˜å…ˆçº§é”™) | 10/10 |
| **ä»£ç ç®€æ´æ€§** | 6/10 (å†—ä½™æ§åˆ¶) | 9/10 |
| **å¯ç»´æŠ¤æ€§** | 6/10 (æ³¨é‡Šä¸ä¸€è‡´) | 9/10 |
| **ç»¼åˆå…¼å®¹æ€§** | 8/10 (éœ€workaround) | 10/10 |
| **ç»¼åˆè¯„ä»·** | éœ€è¦å‡çº§ âš ï¸ | æ¨èä½¿ç”¨ âœ… |

**æœ€ç»ˆå»ºè®®**ï¼šä½¿ç”¨æœ€æ–°ç‰ˆæœ¬è¿›è¡Œå¼€å‘ï¼Œä¿ç•™V0ç‰ˆæœ¬ä»…ä¾›å­¦ä¹ å’Œå¯¹æ¯”ã€‚

---

**ç¥å¯¹æ¯”æµ‹è¯•é¡ºåˆ©ï¼** ğŸ¯
