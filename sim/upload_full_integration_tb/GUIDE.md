# ä¸‰æ¨¡å—é›†æˆä»¿çœŸå®ŒæˆæŒ‡å—

## âœ… å·²åˆ›å»ºçš„æ–‡ä»¶

### 1. æµ‹è¯•å°æ–‡ä»¶
- **ä½ç½®**: `tb/upload_full_integration_tb.v`
- **å¤§å°**: ~500è¡Œä»£ç 
- **åŠŸèƒ½**: å®Œæ•´çš„ä¸‰æ¨¡å—é›†æˆæµ‹è¯•

### 2. ä»¿çœŸè„šæœ¬
- **cmd.do** - ModelSimä¸»ä»¿çœŸè„šæœ¬
- **run_sim.bat** - Windowså¿«é€Ÿå¯åŠ¨è„šæœ¬
- **run_sim.sh** - Linux/Macå¿«é€Ÿå¯åŠ¨è„šæœ¬
- **test_syntax.do** - å¿«é€Ÿè¯­æ³•æ£€æŸ¥è„šæœ¬
- **README.md** - è¯¦ç»†ä½¿ç”¨è¯´æ˜

### 3. ä»¿çœŸç›®å½•
```
sim/upload_full_integration_tb/
â”œâ”€â”€ cmd.do              # ä¸»ä»¿çœŸè„šæœ¬
â”œâ”€â”€ run_sim.bat         # Windowså¯åŠ¨è„šæœ¬
â”œâ”€â”€ run_sim.sh          # Linuxå¯åŠ¨è„šæœ¬
â”œâ”€â”€ test_syntax.do      # è¯­æ³•æ£€æŸ¥è„šæœ¬
â””â”€â”€ README.md           # ä½¿ç”¨æ–‡æ¡£
```

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### Windowsç”¨æˆ·

1. **åŒå‡»è¿è¡Œ**ï¼š
   ```
   sim/upload_full_integration_tb/run_sim.bat
   ```

2. **æˆ–å‘½ä»¤è¡Œ**ï¼š
   ```cmd
   cd F:\FPGA2025\sim\upload_full_integration_tb
   run_sim.bat
   ```

3. **GUIæ¨¡å¼**ï¼š
   ```cmd
   cd F:\FPGA2025\sim\upload_full_integration_tb
   vsim -do cmd.do
   ```

### Linux/Macç”¨æˆ·

```bash
cd /f/FPGA2025/sim/upload_full_integration_tb
./run_sim.sh
```

---

## ğŸ“‹ æµ‹è¯•å†…å®¹

### æ¨¡å—è¿æ¥å…³ç³»
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚UART Handler â”‚ (æ¨¡æ‹Ÿ)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Adapter   â”‚ upload_adapter_0.v
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Packer    â”‚ upload_packer.v (2é€šé“)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚   Arbiter   â”‚ upload_arbiter.v
       â”‚                  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚ SPI Handler â”‚ (æ¨¡æ‹Ÿ)           â–¼
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                  â”‚  Processor  â”‚ (æ¨¡æ‹Ÿ)
       â–¼                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Adapter   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Packer    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
```

### 5ä¸ªæµ‹è¯•åœºæ™¯

| æµ‹è¯• | å†…å®¹ | éªŒè¯ç‚¹ |
|------|------|--------|
| **Test 1** | UARTå•ç‹¬å‘é€3å­—èŠ‚ | Adapter+PackeråŠŸèƒ½ |
| **Test 2** | SPIå•ç‹¬å‘é€4å­—èŠ‚ | åŸºæœ¬åŠŸèƒ½æ­£å¸¸ |
| **Test 3** | å¹¶å‘å‘é€ | **ä¼˜å…ˆçº§+æ•°æ®åŒ…å®Œæ•´æ€§** |
| **Test 4** | èƒŒå‹æµ‹è¯• | Processor busyå¤„ç† |
| **Test 5** | äº¤æ›¿å‘é€ | ä»²è£å…¬å¹³æ€§ |

---

## ğŸ“Š é¢„æœŸè¾“å‡ºç¤ºä¾‹

```
================================================================
  Upload Full Integration Test
  Architecture: Handler -> Adapter -> Packer -> Arbiter
================================================================

================================================================
 TEST 1: UART sends 3 bytes alone
================================================================

[150ns] ===== UART Sending 3 bytes (start=0xC1) =====
[167ns] UART TX: byte[0]=0xC1
[184ns] UART TX: byte[1]=0xC2
[200ns] UART TX: byte[2]=0xC3
[217ns] UART packet complete (total packets=1)

[267ns] OUTPUT: 0xAA (source=0x01, req=1, total=1)
[284ns] OUTPUT: 0x44 (source=0x01, req=1, total=2)
[300ns] OUTPUT: 0x01 (source=0x01, req=1, total=3)
...

[TEST 1 RESULT] Expected: 9 bytes, Received: 9 bytes
TEST 1: âœ“ PASS

================================================================
  FINAL SUMMARY
================================================================
  UART packets sent:     5
  SPI packets sent:      4
  Total packets:         9
  UART bytes sent:       11
  SPI bytes sent:        15
  Total bytes sent:      26
  Total bytes received:  70
================================================================
```

---

## ğŸ” å…³é”®æ³¢å½¢ä¿¡å·

### é¡¶å±‚
- `clk`, `rst_n` - æ—¶é’Ÿå’Œå¤ä½
- `uart_upload_active` / `spi_upload_active` - Handlerä¸Šä¼ çŠ¶æ€

### Adapterå±‚
- `uart_packer_req` / `spi_packer_req` - è½¬æ¢åçš„reqä¿¡å·
- `*_packer_valid` / `*_packer_ready` - æ¡æ‰‹ä¿¡å·

### Packerå±‚
- `state[0]` / `state[1]` - ä¸¤ä¸ªé€šé“çš„çŠ¶æ€æœº
- `data_count[0]` / `data_count[1]` - æ”¶é›†çš„æ•°æ®è®¡æ•°
- `packed_req` - æ‰“åŒ…åçš„reqï¼ˆå‘é‡ï¼‰

### Arbiterå±‚
- `state` - ä»²è£çŠ¶æ€æœº
- `current_source` - å½“å‰é€‰æ‹©çš„æº
- `in_packet` - æ•°æ®åŒ…æ ‡å¿—ï¼ˆå…³é”®ï¼‰
- `gen_fifos[0]/count` / `gen_fifos[1]/count` - FIFOæ·±åº¦

### è¾“å‡º
- `merged_data` - æœ€ç»ˆè¾“å‡ºæ•°æ®
- `merged_source` - æ•°æ®æ¥æºï¼ˆ0x01=UART, 0x03=SPIï¼‰
- `merged_valid` - è¾“å‡ºæœ‰æ•ˆ

---

## ğŸ› æ•…éšœæ’æŸ¥

### é—®é¢˜1ï¼šç¼–è¯‘å¤±è´¥
**ç—‡çŠ¶**: `ERROR: Failed to compile`

**è§£å†³**:
1. æ£€æŸ¥æ–‡ä»¶è·¯å¾„æ˜¯å¦æ­£ç¡®
2. ç¡®è®¤ä¸‰ä¸ªæºæ–‡ä»¶å­˜åœ¨ï¼š
   ```
   rtl/upload_adapter_0.v
   rtl/upload_packer.v
   rtl/upload_arbiter.v
   ```

### é—®é¢˜2ï¼šä»¿çœŸå¡æ­»
**ç—‡çŠ¶**: ä»¿çœŸè¿è¡Œå¾ˆä¹…ä¸ç»“æŸ

**è§£å†³**:
1. æŒ‰ `Ctrl+C` ä¸­æ–­
2. æŸ¥çœ‹æ³¢å½¢ï¼Œæ£€æŸ¥çŠ¶æ€æœºæ˜¯å¦å¡åœ¨æŸä¸ªçŠ¶æ€
3. æ£€æŸ¥ `ready` ä¿¡å·æ˜¯å¦ä¸€ç›´ä¸º0

### é—®é¢˜3ï¼šå­—èŠ‚æ•°ä¸åŒ¹é…
**ç—‡çŠ¶**: æ”¶åˆ°çš„å­—èŠ‚æ•°ä¸é¢„æœŸä¸ç¬¦

**è§£å†³**:
1. æŸ¥çœ‹ç»ˆç«¯è¾“å‡ºï¼Œæ‰¾åˆ°å…·ä½“å“ªä¸ªæµ‹è¯•å¤±è´¥
2. æŸ¥çœ‹æ³¢å½¢ä¸­çš„ `data_count` å’Œ `state`
3. æ£€æŸ¥FIFOæ˜¯å¦æ»¡/æº¢å‡º

### é—®é¢˜4ï¼šæ•°æ®åŒ…è¢«æ‰“æ–­
**ç—‡çŠ¶**: Test 3å¤±è´¥ï¼Œä¼˜å…ˆçº§æŠ¢å æ—¶æ•°æ®æ··ä¹±

**è§£å†³**:
1. æŸ¥çœ‹ `in_packet` ä¿¡å·
2. ç¡®è®¤ä½¿ç”¨çš„æ˜¯ `upload_arbiter.v`ï¼ˆä¸æ˜¯_0ç‰ˆæœ¬ï¼‰
3. æ£€æŸ¥arbiterçš„ `req` ä¿¡å·è¯†åˆ«é€»è¾‘

---

## ğŸ“ ä¿®æ”¹å’Œæ‰©å±•

### å¢åŠ æµ‹è¯•æ•°æ®é‡
ç¼–è¾‘ `tb/upload_full_integration_tb.v`ï¼Œä¿®æ”¹å‘é€å­—èŠ‚æ•°ï¼š

```verilog
// åŸå§‹
send_uart_packet(3, 8'hC1);

// ä¿®æ”¹ä¸º
send_uart_packet(10, 8'hC1);  // å‘é€10å­—èŠ‚
```

### è°ƒæ•´FIFOæ·±åº¦
ç¼–è¾‘ `tb/upload_full_integration_tb.v`ï¼Œç¬¬138è¡Œï¼š

```verilog
upload_arbiter #(
    .NUM_SOURCES(2),
    .FIFO_DEPTH(128)  // æ”¹ä¸º64æˆ–256
)
```

### æ·»åŠ ç¬¬ä¸‰ä¸ªæº
éœ€è¦ä¿®æ”¹ï¼š
1. `NUM_CHANNELS` æ”¹ä¸º 3
2. æ·»åŠ ç¬¬ä¸‰ä¸ªadapterå’Œhandleræ¨¡æ‹Ÿ
3. ä¿®æ”¹arbiterå‚æ•° `NUM_SOURCES` ä¸º 3

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- **åè®®è¯´æ˜**: `doc/USB-CDCé€šä¿¡åè®®.md`
- **Arbiteræµ‹è¯•**: `sim/upload_arbiter_tb/`
- **Packeræµ‹è¯•**: `sim/upload_packer_tb/`
- **é›†æˆæµ‹è¯•**: `sim/upload_integration_tb/` (ä½¿ç”¨simpleç‰ˆæœ¬)

---

## âœ¨ ç‰¹è‰²åŠŸèƒ½

### 1. å®Œæ•´çš„æ•°æ®è·¯å¾„
- ä»Handlerè¾“å‡ºåˆ°Processorè¾“å…¥
- æ‰€æœ‰ä¸‰ä¸ªå…³é”®æ¨¡å—éƒ½è¢«æµ‹è¯•

### 2. çœŸå®åœºæ™¯æ¨¡æ‹Ÿ
- æ¨¡æ‹ŸUART/SPI Handlerçš„ `upload_active` ä¿¡å·
- å¹¶å‘å‘é€åœºæ™¯
- èƒŒå‹å¤„ç†

### 3. è¯¦ç»†çš„æ³¢å½¢
- 80+ä¸ªä¿¡å·
- åˆ†å±‚æ˜¾ç¤ºï¼ˆHandler -> Adapter -> Packer -> Arbiterï¼‰
- å†…éƒ¨çŠ¶æ€æœºå¯è§

### 4. è‡ªåŠ¨åŒ–æµ‹è¯•
- 5ä¸ªç‹¬ç«‹æµ‹è¯•
- è‡ªåŠ¨åˆ¤æ–­Pass/Fail
- è¯¦ç»†ç»Ÿè®¡ä¿¡æ¯

---

## ğŸ¯ éªŒæ”¶æ ‡å‡†

ä»¿çœŸæˆåŠŸçš„æ ‡å¿—ï¼š

âœ… **æ‰€æœ‰ç¼–è¯‘æ— é”™è¯¯**
âœ… **5ä¸ªæµ‹è¯•å…¨éƒ¨PASS**
âœ… **æ— Xæ€ä¼ æ’­**
âœ… **æ•°æ®åŒ…å®Œæ•´æ€§ä¿è¯**ï¼ˆTest 3å…³é”®ï¼‰
âœ… **å­—èŠ‚æ•°ç»Ÿè®¡åŒ¹é…**
âœ… **FIFOæ— æº¢å‡º**

---

## ğŸ’¡ æç¤º

1. **é¦–æ¬¡è¿è¡Œå»ºè®®GUIæ¨¡å¼**ï¼Œå¯ä»¥ç›´è§‚çœ‹åˆ°æ³¢å½¢
2. **é‡ç‚¹å…³æ³¨Test 3**ï¼Œè¿™æ˜¯æœ€èƒ½éªŒè¯arbiteråŠŸèƒ½çš„æµ‹è¯•
3. **æŸ¥çœ‹transcriptæ–‡ä»¶**ï¼Œé‡Œé¢æœ‰å®Œæ•´çš„ä»¿çœŸæ—¥å¿—
4. **å¯¹æ¯”upload_integration_tb**ï¼Œçœ‹çœ‹ä½¿ç”¨simple packerçš„å·®å¼‚

---

## ğŸ”— å¿«é€Ÿé“¾æ¥

- Testbench: `tb/upload_full_integration_tb.v`
- ä»¿çœŸè„šæœ¬: `sim/upload_full_integration_tb/cmd.do`
- ä½¿ç”¨è¯´æ˜: `sim/upload_full_integration_tb/README.md`

---

**ç¥ä»¿çœŸé¡ºåˆ©ï¼** ğŸš€
