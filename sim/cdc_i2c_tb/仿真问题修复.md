# I2Cä»¿çœŸé—®é¢˜ä¿®å¤è®°å½•

## é—®é¢˜1: ä»¿çœŸè¶…æ—¶é—®é¢˜

### é—®é¢˜ç°è±¡
ä»¿çœŸè¿è¡Œæ—¶å‡ºç°è¯»å–è¶…æ—¶é”™è¯¯ï¼š
```
** Error:   -> FAILURE: Timeout waiting for byte 0-3 from DUT.
```

### æ ¹æœ¬åŸå› 
`rtl/i2c/i2c_handler.v` ç¬¬1è¡Œçš„ä»¿çœŸå® `DO_SIM` è¢«æ³¨é‡Šæ‰äº†ï¼š
```verilog
//`define DO_SIM 1  // è¢«æ³¨é‡Šäº†
```

å¯¼è‡´I2Cæ§åˆ¶å™¨ä½¿ç”¨äº†ç¡¬ä»¶æ¿çº§çš„æ—¶é’Ÿåˆ†é¢‘å‚æ•°ï¼ˆ250000ï¼‰è€Œä¸æ˜¯ä»¿çœŸå‚æ•°ï¼ˆ250ï¼‰ï¼Œä½¿å¾—I2Cæ“ä½œæå…¶ç¼“æ…¢ï¼Œtestbenchåœ¨100uså†…æ— æ³•å®Œæˆè¯»å–ã€‚

### è§£å†³æ–¹æ¡ˆ
å¯ç”¨ä»¿çœŸå®å®šä¹‰ï¼š
```verilog
`define DO_SIM 1  // å–æ¶ˆæ³¨é‡Š
```

### ä¿®å¤åçš„æ•ˆæœ
- I2Cæ§åˆ¶å™¨ä½¿ç”¨å¿«é€Ÿä»¿çœŸæ—¶é’Ÿåˆ†é¢‘ï¼ˆ250-1ï¼‰
- I2Cè¯»å–æ“ä½œå¯ä»¥åœ¨åˆç†æ—¶é—´å†…å®Œæˆ
- æµ‹è¯•benchèƒ½å¤Ÿæ­£å¸¸æ¥æ”¶ä¸Šä¼ æ•°æ®

---

## é—®é¢˜2: EEPROMä¿¡å·åç§°é”™è¯¯

### é—®é¢˜ç°è±¡
```
** Error (suppressible): (vopt-7063) ../../tb/cdc_i2c_tb.sv(359):
Failed to find 'MemoryByte' in hierarchical name '/u_eeprom/MemoryByte'.
```

### æ ¹æœ¬åŸå› 
M24LC64 EEPROMæ¨¡å‹ä¸­å­˜å‚¨æ•°ç»„çš„åç§°æ˜¯ `MemoryBlock` è€Œä¸æ˜¯ `MemoryByte`ï¼š
```verilog
// M24LC64.v ä¸­çš„å®šä¹‰
reg  [07:00] MemoryBlock [0:8191];  // æ­£ç¡®çš„åç§°
```

### è§£å†³æ–¹æ¡ˆ
ä¿®æ”¹testbenchä¸­çš„EEPROMè®¿é—®ï¼š
```systemverilog
// é”™è¯¯:
u_eeprom.MemoryByte[WRITE_ADDR+0]

// æ­£ç¡®:
u_eeprom.MemoryBlock[WRITE_ADDR+0]
```

---

## é—®é¢˜3: å˜é‡å£°æ˜è­¦å‘Š

### é—®é¢˜ç°è±¡
```
** Warning: (vlog-2244) Variable 'upload_byte_count' is implicitly static.
** Warning: (vlog-2244) Variable 'prev_state' is implicitly static.
** Warning: (vlog-2244) Variable 'packer_state_i2c' is implicitly static.
```

### æ ¹æœ¬åŸå› 
åœ¨ `initial` å—ä¸­å¸¦åˆå§‹å€¼çš„å˜é‡å£°æ˜éœ€è¦æ˜ç¡®æŒ‡å®šä¸º `automatic` æˆ– `static`ã€‚

### è§£å†³æ–¹æ¡ˆ
å°†å˜é‡å£°æ˜ä¸º `automatic`ï¼š
```systemverilog
// é”™è¯¯:
initial begin
    integer upload_byte_count = 0;

// æ­£ç¡®:
initial begin
    automatic integer upload_byte_count = 0;
```

---

## é—®é¢˜4: Upload Validé‡å¤è„‰å†²å¯¼è‡´æ•°æ®é‡å¤ä¸Šä¼ 

### é—®é¢˜ç°è±¡
åœ¨I2Cè¯»å–æ“ä½œä¸­ï¼Œç¬¬ä¸€ä¸ªå­—èŠ‚(0xDE)è¢«ä¸Šä¼ äº†3æ¬¡ï¼š
```
[6947050000] ğŸ“¤ USB UPLOAD: Data=0xde (Count=5)   â† æ­£ç¡®
[6947110000] ğŸ“¤ USB UPLOAD: Data=0xde (Count=6)   â† é‡å¤!
[6947170000] ğŸ“¤ USB UPLOAD: Data=0xde (Count=7)   â† é‡å¤!
[6947230000] ğŸ“¤ USB UPLOAD: Data=0xad (Count=8)   â† ä¸‹ä¸€ä¸ªå­—èŠ‚
```

### æ ¹æœ¬åŸå› 
`rtl/i2c/i2c_handler.v` ä¸­çš„ `S_UPLOAD_DATA` çŠ¶æ€åœ¨æ¯ä¸ªæ—¶é’Ÿå‘¨æœŸéƒ½æ— æ¡ä»¶è®¾ç½® `upload_valid <= 1'b1`ï¼Œå¯¼è‡´åŒä¸€ä¸ªæ•°æ®è§¦å‘å¤šæ¬¡validè„‰å†²ï¼š

```verilog
// é”™è¯¯çš„ä»£ç  (åŸLine 236):
if (data_ptr_reg < data_len_reg) begin
    upload_data <= read_buffer[data_ptr_reg];
    upload_source <= CMD_I2C_READ;
    upload_valid <= 1'b1;  // âŒ æ¯ä¸ªå‘¨æœŸéƒ½è®¾ç½®ä¸º1

    if (upload_ready) begin
        data_ptr_reg <= data_ptr_reg + 1;  // åªåœ¨readyæ—¶é€’å¢
    end
end
```

**æ—¶åºé—®é¢˜**ï¼š
- å‘¨æœŸ1: `data_ptr=0`, `ready=0` â†’ `valid=1`ä½†æŒ‡é’ˆä¸å˜
- å‘¨æœŸ2: `data_ptr=0`, `ready=0` â†’ `valid=1`æŒ‡é’ˆè¿˜æ˜¯0
- å‘¨æœŸ3: `data_ptr=0`, `ready=1` â†’ `valid=1`ä¸”æŒ‡é’ˆé€’å¢

ç»“æœï¼šåŒä¸€ä¸ª`data_ptr=0`çš„æ•°æ®è§¦å‘äº†3æ¬¡validè„‰å†²

### è§£å†³æ–¹æ¡ˆ
åªåœ¨`upload_ready`ä¸ºé«˜æ—¶æ‰è®¾ç½®`upload_valid`ï¼š
```verilog
// æ­£ç¡®çš„ä»£ç :
if (data_ptr_reg < data_len_reg) begin
    upload_data <= read_buffer[data_ptr_reg];
    upload_source <= CMD_I2C_READ;

    // âœ… åªåœ¨readyä¸ºé«˜æ—¶æ‰å‘å‡ºvalidè„‰å†²
    if (upload_ready) begin
        upload_valid <= 1'b1;
        data_ptr_reg <= data_ptr_reg + 1;
    end
end
```

### ä¿®å¤åŸç†
åˆ©ç”¨é»˜è®¤èµ‹å€¼æœºåˆ¶ï¼ˆLine 121: `upload_valid <= 1'b0;`ï¼‰ï¼š
- **æ¯ä¸ªå‘¨æœŸå¼€å§‹**ï¼š`upload_valid`é»˜è®¤ä¸º0
- **æ¡æ‰‹æ—¶**ï¼šåªåœ¨`upload_ready=1`æ—¶ï¼Œè®¾ç½®`upload_valid=1`ä¸€ä¸ªå‘¨æœŸ
- **åŒæ—¶**ï¼šé€’å¢`data_ptr`ï¼Œä¸‹ä¸€å‘¨æœŸæŒ‡å‘æ–°æ•°æ®

è¿™ç¡®ä¿äº†æ¯ä¸ªå­—èŠ‚åªäº§ç”Ÿ**ä¸€æ¬¡**validè„‰å†²ï¼Œç¬¦åˆæ ‡å‡†Valid/Readyæ¡æ‰‹åè®®ã€‚

### ä¿®å¤åçš„æ•ˆæœ
- æ¯ä¸ªæ•°æ®å­—èŠ‚åªä¸Šä¼ ä¸€æ¬¡
- `upload_valid`è„‰å†²æ•°é‡ç­‰äºæ•°æ®å­—èŠ‚æ•°
- ä¸Šä¼ æ•°æ®æµæ­£ç¡®ï¼š0xDE â†’ 0xAD â†’ 0xBE â†’ 0xEF

### ç›¸å…³æ–‡æ¡£
è¯¦ç»†çš„åŸç†åˆ†æå’ŒéªŒè¯æ–¹æ³•è¯·å‚è€ƒï¼š[UPLOAD_FIX.md](./UPLOAD_FIX.md)

---

## æ³¨æ„äº‹é¡¹

### âš ï¸ æ¿çº§ç»¼åˆå‰çš„æ£€æŸ¥
å½“ä½ è¦ç»¼åˆåˆ°FPGAæ¿ä¸Šæ—¶ï¼Œ**å¿…é¡»é‡æ–°æ³¨é‡Šæ‰DO_SIMå®å®šä¹‰**ï¼š
```verilog
//`define DO_SIM 1  // æ¿çº§éªŒè¯å¿…é¡»æ³¨é‡Šæ‰
```
å¦åˆ™I2Cæ—¶é’Ÿä¼šå¤ªå¿«ï¼Œå¯èƒ½å¯¼è‡´EEPROMé€šä¿¡å¤±è´¥ã€‚

### ğŸ“‹ M24LC64ä¿¡å·å‚è€ƒ
- `MemoryBlock[0:8191]` - 8KBå­˜å‚¨æ•°ç»„
- `StartAddress` - èµ·å§‹åœ°å€ï¼ˆ13ä½ï¼‰
- `RdPointer` - è¯»å–æŒ‡é’ˆï¼ˆ13ä½ï¼‰
- `WrCycle` - å†™å‘¨æœŸæ ‡å¿—
- `RdCycle` - è¯»å‘¨æœŸæ ‡å¿—
- `WriteActive` - å†™æ¿€æ´»æ ‡å¿—

---
ä¿®å¤æ—¶é—´ï¼š2025-10-18
æœ€åæ›´æ–°ï¼š2025-10-18 (æ–°å¢é—®é¢˜4: Upload Validé‡å¤è„‰å†²)

