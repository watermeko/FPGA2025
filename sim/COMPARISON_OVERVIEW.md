# ğŸ¯ ä¸¤ç‰ˆæœ¬ä»¿çœŸç¯å¢ƒå®Œæˆæ€»ç»“

## âœ… äº¤ä»˜å†…å®¹

æ‚¨ç°åœ¨æ‹¥æœ‰**ä¸¤å¥—å®Œæ•´çš„ä»¿çœŸç¯å¢ƒ**ï¼Œå¯ä»¥å¯¹æ¯”å­¦ä¹ æ¨¡å—çš„æ¼”è¿›è¿‡ç¨‹ï¼

---

## ğŸ“¦ ä»¿çœŸç¯å¢ƒæ€»è§ˆ

### ğŸ”· ç‰ˆæœ¬1ï¼šæœ€æ–°ç‰ˆï¼ˆæ¨èä½¿ç”¨ï¼‰

**ä½ç½®**: `sim/upload_full_integration_tb/`

| æ–‡ä»¶ | è¯´æ˜ | è¡Œæ•° |
|------|------|------|
| Testbench | `tb/upload_full_integration_tb.v` | 451è¡Œ |
| ä»¿çœŸè„šæœ¬ | `cmd.do` | 189è¡Œ |
| README | ä½¿ç”¨è¯´æ˜ | 188è¡Œ |
| GUIDE | å®Œæ•´æŒ‡å— | 311è¡Œ |

**ä½¿ç”¨æ¨¡å—**ï¼š
- âœ… `upload_adapter_0.v`
- âœ… `upload_packer.v` (æœ€æ–°ç‰ˆï¼Œä¸å¸¦0)
- âœ… `upload_arbiter.v` (æœ€æ–°ç‰ˆï¼ŒUARTä¼˜å…ˆçº§)

**ç‰¹ç‚¹**ï¼š
- âœ… æ— Bug
- âœ… ä»£ç ç®€æ´
- âœ… æ³¨é‡Šä¸€è‡´
- âœ… æ¨èç”Ÿäº§ä½¿ç”¨

---

### ğŸ”¶ ç‰ˆæœ¬2ï¼šV0ç‰ˆï¼ˆå­¦ä¹ å¯¹æ¯”ï¼‰

**ä½ç½®**: `sim/upload_full_integration_v0_tb/`

| æ–‡ä»¶ | è¯´æ˜ | è¡Œæ•° |
|------|------|------|
| Testbench | `tb/upload_full_integration_v0_tb.v` | 458è¡Œ |
| ä»¿çœŸè„šæœ¬ | `cmd.do` | 199è¡Œ |
| README | ä½¿ç”¨è¯´æ˜ | 316è¡Œ |
| ç‰ˆæœ¬å¯¹æ¯” | `VERSION_COMPARISON.md` | 346è¡Œ |

**ä½¿ç”¨æ¨¡å—**ï¼š
- âš ï¸ `upload_adapter_0.v`
- âš ï¸ `upload_packer_0.v` (å¸¦0ç‰ˆæœ¬)
- âš ï¸ `upload_arbiter_0.v` (å¸¦0ç‰ˆæœ¬ï¼Œ**SPIä¼˜å…ˆçº§Bug**)

**ç‰¹ç‚¹**ï¼š
- âš ï¸ åŒ…å«ä¼˜å…ˆçº§Bug
- âš ï¸ ä»£ç å†—ä½™ï¼ˆworkaroundï¼‰
- âš ï¸ æ³¨é‡Šä¸ä»£ç ä¸ä¸€è‡´
- âš ï¸ ä»…ç”¨äºå­¦ä¹ å¯¹æ¯”

---

## ğŸ¯ å¿«é€Ÿå¼€å§‹

### è¿è¡Œæœ€æ–°ç‰ˆï¼ˆæ¨èï¼‰
```bash
cd sim/upload_full_integration_tb
./run_sim.bat         # Windows
./run_sim.sh          # Linux/Mac
```

### è¿è¡ŒV0ç‰ˆï¼ˆå¯¹æ¯”å­¦ä¹ ï¼‰
```bash
cd sim/upload_full_integration_v0_tb
./run_sim.bat         # Windows
```

### GUIæ¨¡å¼
```bash
cd sim/upload_full_integration_tb
vsim -do cmd.do       # æ‰“å¼€æ³¢å½¢æŸ¥çœ‹å™¨
```

---

## ğŸ“Š å…³é”®å·®å¼‚å¯¹æ¯”

### æ ¸å¿ƒBugå¯¹æ¯”

| æµ‹è¯•åœºæ™¯ | V0ç‰ˆæœ¬ç»“æœ | æœ€æ–°ç‰ˆç»“æœ |
|----------|-----------|-----------|
| Test 1: UARTå•å‘ | âœ… PASS | âœ… PASS |
| Test 2: SPIå•å‘ | âœ… PASS | âœ… PASS |
| **Test 3: å¹¶å‘** | âš ï¸ **SPIå…ˆæœåŠ¡** | âœ… **UARTå…ˆæœåŠ¡** |
| Test 4: èƒŒå‹ | âœ… PASS | âœ… PASS |
| Test 5: äº¤æ›¿ | âœ… PASS | âœ… PASS |

### ä»£ç å®ç°å¯¹æ¯”

**ä¼˜å…ˆçº§é€»è¾‘**ï¼š

```verilog
// ========== V0ç‰ˆæœ¬ (Bug) ==========
// upload_arbiter_0.v:142
assign next_source = fifo_has_data[1] ? 2'd1 : 2'd0;
// ç»“æœï¼šSPI(1) > UART(0) âŒ


// ========== æœ€æ–°ç‰ˆ (ä¿®å¤) ==========
// upload_arbiter.v:138
assign next_source = fifo_has_data[0] ? 2'd0 : 2'd1;
// ç»“æœï¼šUART(0) > SPI(1) âœ…
```

**æ§åˆ¶ä¿¡å·å¯¹æ¯”**ï¼š

```verilog
// ========== V0ç‰ˆæœ¬ (é—´æ¥æ§åˆ¶) ==========
reg [NUM_SOURCES-1:0] fifo_rd_en_ctrl;  // ä¸­é—´ä¿¡å·
wire fifo_rd_en;
assign fifo_rd_en = fifo_rd_en_ctrl[i];

// çŠ¶æ€æœºä¸­ï¼š
fifo_rd_en_ctrl[next_source] <= 1'b1;


// ========== æœ€æ–°ç‰ˆ (ç›´æ¥æ§åˆ¶) ==========
reg  fifo_rd_en;  // ç›´æ¥åœ¨generateå—å†…

// çŠ¶æ€æœºä¸­ï¼š
gen_fifos[0].fifo_rd_en <= 1'b1;
```

---

## ğŸ” å­¦ä¹ è·¯å¾„å»ºè®®

### Step 1: ç†è§£æ­£ç¡®ç‰ˆæœ¬
1. è¿è¡Œæœ€æ–°ç‰ˆä»¿çœŸ
2. æŸ¥çœ‹å®Œæ•´æ³¢å½¢
3. ç†è§£æ­£ç¡®çš„ä¼˜å…ˆçº§è¡Œä¸º

### Step 2: è§‚å¯ŸBugç‰ˆæœ¬
1. è¿è¡ŒV0ç‰ˆä»¿çœŸ
2. é‡ç‚¹è§‚å¯ŸTest 3
3. ç¡®è®¤SPIä¼˜å…ˆçº§Bug

### Step 3: å¯¹æ¯”åˆ†æ
1. åŒæ—¶æ‰“å¼€ä¸¤ä¸ªæ³¢å½¢
2. å¯¹æ¯”`next_source`ä¿¡å·
3. è§‚å¯Ÿ`merged_source`å·®å¼‚

### Step 4: ä»£ç åˆ†æ
1. é˜…è¯»`VERSION_COMPARISON.md`
2. å¯¹æ¯”æºä»£ç å·®å¼‚
3. ç†è§£ä¿®å¤åŸç†

---

## ğŸ“ˆ æ³¢å½¢è§‚å¯Ÿè¦ç‚¹

### Test 3å¹¶å‘æµ‹è¯•ï¼ˆå…³é”®ï¼‰

**æœ€æ–°ç‰ˆæ³¢å½¢**ï¼š
```
Time: 100ns  â”Œâ”€ UART active=1
             â”‚  SPI active=1
Time: 150ns  â”‚
             â–¼
Time: 200ns  â”œâ”€ next_source = 2'd0 (UARTä¼˜å…ˆ) âœ…
             â”œâ”€ current_sourceåˆ‡æ¢åˆ°0
Time: 300ns  â”œâ”€ merged_source = 0x01 (UARTæ•°æ®)
             â”‚
Time: 450ns  â”œâ”€ UARTæ•°æ®åŒ…ä¼ è¾“å®Œæˆ
             â–¼
Time: 460ns  â”œâ”€ next_source = 2'd1 (åˆ‡æ¢SPI)
             â”œâ”€ current_sourceåˆ‡æ¢åˆ°1
Time: 500ns  â”œâ”€ merged_source = 0x03 (SPIæ•°æ®)
             â–¼
```

**V0ç‰ˆæ³¢å½¢**ï¼š
```
Time: 100ns  â”Œâ”€ UART active=1
             â”‚  SPI active=1
Time: 150ns  â”‚
             â–¼
Time: 200ns  â”œâ”€ next_source = 2'd1 (SPIä¼˜å…ˆ) âŒ
             â”œâ”€ current_sourceåˆ‡æ¢åˆ°1
Time: 300ns  â”œâ”€ merged_source = 0x03 (SPIæ•°æ®)
             â”‚
Time: 550ns  â”œâ”€ SPIæ•°æ®åŒ…ä¼ è¾“å®Œæˆ
             â–¼
Time: 560ns  â”œâ”€ next_source = 2'd0 (åˆ‡æ¢UART)
             â”œâ”€ current_sourceåˆ‡æ¢åˆ°0
Time: 600ns  â”œâ”€ merged_source = 0x01 (UARTæ•°æ®)
             â–¼
```

**å…³é”®è§‚å¯Ÿ**ï¼š
- V0ç‰ˆæœ¬ä¸­SPIå…ˆè¢«æœåŠ¡ï¼ˆBugï¼‰
- æœ€æ–°ç‰ˆæœ¬ä¸­UARTå…ˆè¢«æœåŠ¡ï¼ˆæ­£ç¡®ï¼‰
- æ—¶é—´å·®çº¦100nså·¦å³

---

## ğŸ“ æ•™å­¦ä»·å€¼

### è¿™ä¸¤ä¸ªä»¿çœŸç¯å¢ƒæ•™ä¼šä½ 

1. **Bugè¯†åˆ«æŠ€å·§**
   - é€šè¿‡å¯¹æ¯”æµ‹è¯•å‘ç°é—®é¢˜
   - æ³¢å½¢åˆ†æå®šä½Bug
   - æ—¥å¿—è¾“å‡ºè¾…åŠ©åˆ¤æ–­

2. **ä»£ç æ¼”è¿›è¿‡ç¨‹**
   - ä»workaroundåˆ°ç›´æ¥å®ç°
   - ä»Bugåˆ°ä¿®å¤çš„è¿‡ç¨‹
   - å·¥å…·æ”¯æŒçš„æå‡

3. **ä¼˜å…ˆçº§è®¾è®¡**
   - å¦‚ä½•æ­£ç¡®å®ç°ä¼˜å…ˆçº§
   - å¸¸è§çš„ä¼˜å…ˆçº§Bug
   - æµ‹è¯•éªŒè¯çš„é‡è¦æ€§

4. **æ³¨é‡Šè§„èŒƒ**
   - æ³¨é‡Šä¸ä»£ç å¿…é¡»ä¸€è‡´
   - ä¸ä¸€è‡´ä¼šéšè—Bug
   - å¢åŠ ç»´æŠ¤éš¾åº¦

5. **è°ƒè¯•æ–¹æ³•**
   - ä½¿ç”¨ç›‘æ§å˜é‡
   - æ³¢å½¢å¯¹æ¯”åˆ†æ
   - ç‰ˆæœ¬å¯¹æ¯”éªŒè¯

---

## ğŸ† éªŒæ”¶æ ‡å‡†

### æœ€æ–°ç‰ˆéªŒæ”¶ï¼ˆç”Ÿäº§ä½¿ç”¨ï¼‰

âœ… æ‰€æœ‰æµ‹è¯•PASS
âœ… Test 3: UARTä¼˜å…ˆæœåŠ¡
âœ… æ— æ•°æ®ä¸¢å¤±
âœ… FIFOæ— æº¢å‡º
âœ… æ³¢å½¢æ— Xæ€

### V0ç‰ˆéªŒæ”¶ï¼ˆå­¦ä¹ éªŒè¯ï¼‰

âœ… Test 1-2 PASS
âš ï¸ Test 3: SPIä¼˜å…ˆæœåŠ¡ï¼ˆBugç‰¹å¾ï¼‰
âœ… Test 4-5 PASS
âœ… ç»ˆç«¯æ˜¾ç¤ºBugè­¦å‘Š

---

## ğŸ“š æ–‡æ¡£ç´¢å¼•

### æœ€æ–°ç‰ˆæ–‡æ¡£
- ğŸ“„ `sim/upload_full_integration_tb/README.md` - å¿«é€Ÿä¸Šæ‰‹
- ğŸ“„ `sim/upload_full_integration_tb/GUIDE.md` - å®Œæ•´æŒ‡å—
- ğŸ“„ `sim/upload_full_integration_tb/cmd.do` - ä»¿çœŸè„šæœ¬

### V0ç‰ˆæ–‡æ¡£
- ğŸ“„ `sim/upload_full_integration_v0_tb/README.md` - V0è¯´æ˜
- ğŸ“„ `sim/upload_full_integration_v0_tb/VERSION_COMPARISON.md` - è¯¦ç»†å¯¹æ¯”
- ğŸ“„ `sim/upload_full_integration_v0_tb/cmd.do` - V0ä»¿çœŸè„šæœ¬

### æºä»£ç 
- ğŸ“ `rtl/upload_adapter_0.v` - Adapterï¼ˆå…±ç”¨ï¼‰
- ğŸ“ `rtl/upload_packer.v` - Packerï¼ˆæœ€æ–°ç‰ˆï¼‰
- ğŸ“ `rtl/upload_packer_0.v` - Packerï¼ˆV0ç‰ˆï¼‰
- ğŸ“ `rtl/upload_arbiter.v` - Arbiterï¼ˆæœ€æ–°ç‰ˆï¼‰
- ğŸ“ `rtl/upload_arbiter_0.v` - Arbiterï¼ˆV0ç‰ˆï¼Œæœ‰Bugï¼‰

---

## ğŸ’¡ æ¨èå®éªŒ

### å®éªŒ1ï¼šBugé‡ç°
```bash
# è¿è¡ŒV0ç‰ˆæœ¬
cd sim/upload_full_integration_v0_tb
./run_sim.bat

# è§‚å¯ŸTest 3è¾“å‡º
# åº”è¯¥çœ‹åˆ°ï¼šSPI served first (0x03) - Bug confirmed!
```

### å®éªŒ2ï¼šBugä¿®å¤éªŒè¯
```bash
# è¿è¡Œæœ€æ–°ç‰ˆæœ¬
cd sim/upload_full_integration_tb
./run_sim.bat

# è§‚å¯ŸTest 3è¾“å‡º
# åº”è¯¥çœ‹åˆ°ï¼šUARTå…ˆè¢«æœåŠ¡
```

### å®éªŒ3ï¼šæ³¢å½¢å¯¹æ¯”
1. è¿è¡Œä¸¤ä¸ªç‰ˆæœ¬ä»¿çœŸ
2. åœ¨GTKWaveæˆ–ModelSimä¸­æ‰“å¼€ä¸¤ä¸ªæ³¢å½¢
3. å¯¹é½æ—¶é—´è½´åˆ°Test 3å¼€å§‹
4. å¯¹æ¯”`next_source`å’Œ`current_source`ä¿¡å·

### å®éªŒ4ï¼šä»£ç ä¿®æ”¹
åœ¨V0ç‰ˆæœ¬ä¸­æ‰‹åŠ¨ä¿®å¤Bugï¼š
```verilog
// ç¼–è¾‘ rtl/upload_arbiter_0.v ç¬¬142è¡Œ
// æ”¹ä¸ºï¼š
assign next_source = fifo_has_data[0] ? 2'd0 : 2'd1;

// é‡æ–°ç¼–è¯‘è¿è¡Œ
cd sim/upload_full_integration_v0_tb
vsim -c -do cmd.do

// è§‚å¯ŸTest 3æ˜¯å¦å˜æ­£ç¡®
```

---

## ğŸ¯ ä½¿ç”¨å»ºè®®

### æ­£å¼å¼€å‘
- âœ… **ä½¿ç”¨æœ€æ–°ç‰ˆ**: `sim/upload_full_integration_tb/`
- âœ… ä»£ç ç¨³å®šå¯é 
- âœ… æ— å·²çŸ¥Bug
- âœ… ç»´æŠ¤æ€§å¥½

### å­¦ä¹ ç ”ç©¶
- ğŸ“š **å¯¹æ¯”ä¸¤ä¸ªç‰ˆæœ¬**
- ğŸ“š ç†è§£Bugäº§ç”ŸåŸå› 
- ğŸ“š å­¦ä¹ è°ƒè¯•æŠ€å·§
- ğŸ“š äº†è§£ä»£ç æ¼”è¿›

### æ•™å­¦æ¼”ç¤º
- ğŸ“ å±•ç¤ºBugçš„è¡¨ç°
- ğŸ“ æ¼”ç¤ºä¿®å¤è¿‡ç¨‹
- ğŸ“ è¯´æ˜ä¼˜å…ˆçº§è®¾è®¡
- ğŸ“ å¼ºè°ƒæ³¨é‡Šè§„èŒƒ

---

## ğŸ“Š ç»Ÿè®¡ä¿¡æ¯

### ä»£ç é‡ç»Ÿè®¡

| é¡¹ç›® | æœ€æ–°ç‰ˆ | V0ç‰ˆ | å·®å¼‚ |
|------|--------|------|------|
| Testbench | 451è¡Œ | 458è¡Œ | +7è¡Œï¼ˆå¢åŠ Bugç›‘æ§ï¼‰ |
| ä»¿çœŸè„šæœ¬ | 189è¡Œ | 199è¡Œ | +10è¡Œï¼ˆå¢åŠ Bugæ ‡æ³¨ï¼‰ |
| æ–‡æ¡£ | 499è¡Œ | 662è¡Œ | +163è¡Œï¼ˆè¯¦ç»†è¯´æ˜ï¼‰ |
| **æ€»è®¡** | 1139è¡Œ | 1319è¡Œ | +180è¡Œ |

### æ–‡ä»¶ç»“æ„

```
sim/
â”œâ”€â”€ upload_full_integration_tb/          # æœ€æ–°ç‰ˆï¼ˆæ¨èï¼‰
â”‚   â”œâ”€â”€ cmd.do                          # ä»¿çœŸè„šæœ¬
â”‚   â”œâ”€â”€ run_sim.bat / .sh               # å¯åŠ¨è„šæœ¬
â”‚   â”œâ”€â”€ README.md                       # ä½¿ç”¨è¯´æ˜
â”‚   â””â”€â”€ GUIDE.md                        # å®Œæ•´æŒ‡å—
â”‚
â””â”€â”€ upload_full_integration_v0_tb/       # V0ç‰ˆï¼ˆå­¦ä¹ ï¼‰
    â”œâ”€â”€ cmd.do                          # V0ä»¿çœŸè„šæœ¬
    â”œâ”€â”€ run_sim.bat / .sh               # V0å¯åŠ¨è„šæœ¬
    â”œâ”€â”€ README.md                       # V0è¯´æ˜
    â””â”€â”€ VERSION_COMPARISON.md           # ç‰ˆæœ¬å¯¹æ¯”

tb/
â”œâ”€â”€ upload_full_integration_tb.v         # æœ€æ–°ç‰ˆtestbench
â””â”€â”€ upload_full_integration_v0_tb.v      # V0ç‰ˆtestbench
```

---

## âœ¨ æ€»ç»“

ç°åœ¨æ‚¨æ‹¥æœ‰ï¼š

âœ… **ä¸¤å¥—å®Œæ•´çš„ä»¿çœŸç¯å¢ƒ**
- æœ€æ–°ç‰ˆï¼šæ— Bugï¼Œæ¨èä½¿ç”¨
- V0ç‰ˆï¼šåŒ…å«Bugï¼Œç”¨äºå­¦ä¹ 

âœ… **è¯¦ç»†çš„å¯¹æ¯”æ–‡æ¡£**
- ä»£ç å·®å¼‚åˆ†æ
- Bugè¡¨ç°è¯´æ˜
- ä¿®å¤è¿‡ç¨‹å±•ç¤º

âœ… **ä¸°å¯Œçš„å­¦ä¹ èµ„æº**
- æ³¢å½¢å¯¹æ¯”
- ä»£ç æ¼”è¿›
- è°ƒè¯•æŠ€å·§

âœ… **ä¾¿æ·çš„è¿è¡Œè„šæœ¬**
- ä¸€é”®å¯åŠ¨
- è·¨å¹³å°æ”¯æŒ
- GUI/å‘½ä»¤è¡ŒåŒæ¨¡å¼

---

## ğŸš€ ä¸‹ä¸€æ­¥

1. **å…ˆè¿è¡Œæœ€æ–°ç‰ˆ**
   ```bash
   cd sim/upload_full_integration_tb
   ./run_sim.bat
   ```

2. **å†è¿è¡ŒV0ç‰ˆ**
   ```bash
   cd sim/upload_full_integration_v0_tb
   ./run_sim.bat
   ```

3. **å¯¹æ¯”æ³¢å½¢å’Œè¾“å‡º**
   - é‡ç‚¹å…³æ³¨Test 3
   - è§‚å¯Ÿä¼˜å…ˆçº§å·®å¼‚

4. **é˜…è¯»å¯¹æ¯”æ–‡æ¡£**
   ```bash
   cat sim/upload_full_integration_v0_tb/VERSION_COMPARISON.md
   ```

---

**ä¸¤å¥—ä»¿çœŸç¯å¢ƒå·²å°±ç»ªï¼Œå¼€å§‹æ‚¨çš„å¯¹æ¯”å­¦ä¹ ä¹‹æ—…å§ï¼** ğŸ“âœ¨
