# Digital Capture 工具使用说明

## 功能概述

`dc_command_tool.py` 是一个多功能的数字捕获工具，提供：

1. **命令生成器** - 生成正确的DC启动/停止命令
2. **实时波形绘制** - 8通道数字信号实时可视化
3. **串口通信** - 自动连接USB CDC设备

---

## 安装依赖

```bash
pip install pyserial numpy matplotlib
```

**所需Python库：**
- `pyserial` - 串口通信
- `numpy` - 数据处理
- `matplotlib` - 波形绘制

---

## 使用方法

### 模式1：交互式波形绘制（默认）

```bash
python dc_command_tool.py
```

**运行流程：**

1. **选择串口**
   ```
   可用串口:
   1. COM3 - USB Serial Port
   2. COM5 - USB-SERIAL CH340

   请输入串口编号: 1
   ```

2. **选择采样率**
   ```
   选择采样率:
   1. 1 MHz (最高)
   2. 500 kHz
   3. 100 kHz
   4. 10 kHz
   5. 1 kHz

   请输入采样率编号: 2
   ```

3. **自动执行：**
   - ✅ 连接串口
   - ✅ 发送启动命令 `AA 55 0B ...`
   - ✅ 开启后台数据读取线程
   - ✅ 弹出波形显示窗口（8个子图）

4. **实时显示：**
   - 8个通道分别显示在不同的子图中
   - CH0 = Bit[0], CH1 = Bit[1], ..., CH7 = Bit[7]
   - 滚动显示最近1000个采样点
   - 顶部状态栏显示：采样数、运行时间、实际采样率

5. **停止捕获：**
   - 关闭波形窗口，或
   - 按 `Ctrl+C`
   - 自动发送停止命令 `AA 55 0C 00 00 0C`

---

### 模式2：仅生成命令

```bash
python dc_command_tool.py --generate
```

输出所有预设采样率的命令：

```
1 MHz (推荐最高):
----------------------------------------
目标采样率: 1000000 Hz
分频系数: 60 (0x003C)
实际采样率: 1000000.00 Hz
完整命令: AA 55 0B 00 02 00 3C 49
命令长度: 8 字节

500 kHz:
----------------------------------------
目标采样率: 500000 Hz
分频系数: 120 (0x0078)
实际采样率: 500000.00 Hz
完整命令: AA 55 0B 00 02 00 78 85
...

DC停止命令:
----------------------------------------
DC停止命令: AA 55 0C 00 00 0C
```

---

## 波形窗口说明

### 界面布局

```
┌─────────────────────────────────────────────────────┐
│ 8-Channel Digital Capture Waveform                  │
│ Samples: 12,345 | Time: 12.3s | Rate: 1000.0 samples/s │
├─────────────────────────────────────────────────────┤
│  CH7 │ ▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁  │
│      │ HIGH / LOW                                   │
├──────┼──────────────────────────────────────────────┤
│  CH6 │ ▔▔▔▔▔▁▁▁▁▔▔▔▔▔▁▁▁▁▔▔▔▔▔▁▁▁▁▔▔▔▔▔▁▁▁▁▔▔▔▔  │
├──────┼──────────────────────────────────────────────┤
│  CH5 │ ▁▁▔▔▁▁▔▔▁▁▔▔▁▁▔▔▁▁▔▔▁▁▔▔▁▁▔▔▁▁▔▔▁▁▔▔▁▁  │
├──────┼──────────────────────────────────────────────┤
│  ...                                                 │
├──────┼──────────────────────────────────────────────┤
│  CH0 │ ▔▔▔▔▔▔▔▔▔▁▁▁▁▁▁▁▁▁▔▔▔▔▔▔▔▔▔▁▁▁▁▁▁▁▁▁▔▔▔  │
│      └───────────────────────────────────────────────┤
│                    Sample Count                      │
└─────────────────────────────────────────────────────┘
```

### 通道映射

每个接收字节的8个bit分别对应8个通道：

```
接收字节 = 0xA5 = 10100101 (二进制)
              ││││││││
              ││││││││
              ││││││└───→ CH0 = 1 (HIGH)
              │││││└────→ CH1 = 0 (LOW)
              ││││└─────→ CH2 = 1 (HIGH)
              │││└──────→ CH3 = 0 (LOW)
              ││└───────→ CH4 = 0 (LOW)
              │└────────→ CH5 = 1 (HIGH)
              └─────────→ CH6 = 0 (LOW)
              ──────────→ CH7 = 1 (HIGH)
```

---

## 命令格式详解

### 启动命令 (0x0B)

```
AA 55 0B 00 02 [DIV_H] [DIV_L] [CHECKSUM]
│  │  │  │  │     │       │         │
│  │  │  │  │     │       │         └─ 校验和 (所有字节累加)
│  │  │  │  │     │       └─────────── 分频系数低字节
│  │  │  │  │     └─────────────────── 分频系数高字节
│  │  │  │  └───────────────────────── 数据长度 = 2
│  │  │  └──────────────────────────── 数据长度高字节
│  │  └─────────────────────────────── 功能码 0x0B
│  └────────────────────────────────── 帧头第2字节
└───────────────────────────────────── 帧头第1字节
```

**校验和计算：**
```python
checksum = (0x0B + 0x00 + 0x02 + DIV_H + DIV_L) & 0xFF
```

**分频系数计算：**
```
divider = 60,000,000 / 目标采样率

例如：
1 MHz:   divider = 60   → 命令: AA 55 0B 00 02 00 3C 49
500 kHz: divider = 120  → 命令: AA 55 0B 00 02 00 78 85
100 kHz: divider = 600  → 命令: AA 55 0B 00 02 02 58 61
```

### 停止命令 (0x0C)

```
AA 55 0C 00 00 0C
│  │  │  │  │  │
│  │  │  │  │  └─ 校验和 = 0x0C
│  │  │  │  └──── 数据长度 = 0
│  │  │  └─────── 数据长度高字节
│  │  └────────── 功能码 0x0C
│  └───────────── 帧头第2字节
└──────────────── 帧头第1字节
```

---

## 常见问题排查

### 1. 校验和错误 - 无数据上传

**问题：** 发送命令后没有任何响应

**原因：** 校验和计算错误，FPGA拒绝命令

**解决：**
```bash
# 使用工具生成正确命令
python dc_command_tool.py --generate

# 或使用交互模式（自动计算）
python dc_command_tool.py
```

### 2. 只有CH0有数据，其他通道全0

**原因：** 引脚约束只配置了 `dc_signal_in[0]`

**当前状态：**
```
dc_signal_in[0] → F14 ✅ 有效
dc_signal_in[1:7] → 未约束 ❌ 数据不确定
```

**解决：**
- 只使用CH0：正常，读取Bit[0]即可
- 需要多通道：修改 `pin_cons.cst` 添加引脚约束

### 3. 波形显示卡顿

**原因：** 采样率过高，绘图帧率跟不上

**解决：**
- 降低采样率（100 kHz 以下更流畅）
- 减少 `buffer_size`（修改代码第398行）

### 4. 串口无法打开

**原因：** 权限不足或设备占用

**解决：**
```bash
# Windows: 确保其他软件未占用串口
# Linux: 添加用户到dialout组
sudo usermod -a -G dialout $USER
```

---

## 引脚连接

### 当前配置（仅CH0）

```
FPGA引脚 F14 ←→ 数字信号输入 (CH0)
```

### 完整配置（8通道）

需要修改 `constraints/pin_cons.cst` 启用所有通道：

```
dc_signal_in[0] → F14
dc_signal_in[1] → B18
dc_signal_in[2] → D18
dc_signal_in[3] → E15
dc_signal_in[4] → E14
dc_signal_in[5] → F15
dc_signal_in[6] → F13
dc_signal_in[7] → G15
```

---

## 性能指标

| 参数 | 值 |
|------|------|
| 最大采样率 | 1.2 MHz (理论) |
| 推荐采样率 | ≤ 1 MHz (稳定) |
| 通道数 | 8 (并行采样) |
| 数据格式 | 直通模式（无协议头） |
| 缓冲区大小 | 1000 采样点（可配置） |
| 绘图帧率 | 30 fps |

---

## 快速开始示例

### Python代码调用

```python
from dc_command_tool import DigitalCaptureWaveform

# 创建绘图器
plotter = DigitalCaptureWaveform(
    port="COM3",
    baudrate=115200,
    buffer_size=2000  # 显示2000个点
)

# 运行（500kHz采样）
plotter.run(sample_rate_hz=500_000)
```

### 命令行快速测试

```bash
# 1. 生成命令
python dc_command_tool.py --generate > commands.txt

# 2. 交互式运行
python dc_command_tool.py
# 选择串口 → 选择采样率 → 自动显示波形
```

---

## 技术细节

### 数据流水线

```
FPGA (dc_signal_in[7:0])
  ↓
采样 (60MHz / divider)
  ↓
打包为1字节
  ↓
USB CDC → PC串口
  ↓
Python读取线程
  ↓
bit解析 (8个通道)
  ↓
循环缓冲区 (deque)
  ↓
matplotlib动画更新 (30fps)
```

### 多线程架构

- **主线程**：GUI绘图（matplotlib）
- **后台线程**：串口数据读取（daemon线程）
- **数据同步**：deque线程安全

---

## 更新日志

**v2.0** (当前版本)
- ✅ 添加实时8通道波形绘制
- ✅ 交互式串口选择
- ✅ 自动校验和计算
- ✅ 状态栏显示采样统计

**v1.0**
- 命令生成器
- 校验和计算

---

## 联系与支持

如有问题，请检查：
1. 校验和是否正确（使用 `--generate` 模式）
2. 串口是否正确连接
3. FPGA是否已下载比特流
4. dc_signal_in 引脚是否有有效信号

**相关文件：**
- RTL代码：`rtl/logic/digital_capture_handler.v`
- CDC集成：`rtl/cdc.v:442`
- 引脚约束：`constraints/pin_cons.cst:81`
- 协议文档：`doc/USB-CDC通信协议.md`
