# å®Œæ•´æ•°æ®è·¯å¾„ç“¶é¢ˆåˆ†æ

## æ•°æ®æµå‘å’Œç¼“å†²åŒºå¤§å°

```
DC Handler (10 KB/sç”Ÿäº§)
    |
    | upload_readyä¿¡å·ï¼ˆæ¥è‡ªArbiterï¼‰
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Upload Arbiter FIFO: 128 bytes      â”‚ â† âš ï¸ ç¬¬ä¸€ä¸ªç“¶é¢ˆï¼
â”‚ (upload_arbiter_0.v:20)             â”‚
â”‚ FIFO_DEPTH = 128                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    |
    | processor_upload_readyï¼ˆæ°¸è¿œæ˜¯1ï¼‰
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Command Processor: æ— ç¼“å†²           â”‚
â”‚ (command_processor.v:86)            â”‚
â”‚ upload_ready_out <= 1'b1 (ç›´é€š)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    |
    | usb_upload_valid
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ USB EP2_IN FIFO: 4 KB (4096 bytes) â”‚ â† âš ï¸ ç¬¬äºŒä¸ªç“¶é¢ˆï¼
â”‚ (usb_fifo.v:45)                     â”‚
â”‚ EP2_IN_BUF_ASIZE = 12 (2^12=4096)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    |
    | USB PHYä¼ è¾“
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ USB CDC Controller                  â”‚ â† âš ï¸ ç¬¬ä¸‰ä¸ªç“¶é¢ˆï¼
â”‚ - 512å­—èŠ‚åŒ…                         â”‚
â”‚ - High-Speed (480 Mbpsç†è®º)        â”‚
â”‚ - CDCåè®®å¼€é”€                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    |
    | USBæ€»çº¿
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Windows CDC Driver: ~24 KBç¼“å†²     â”‚ â† âš ï¸ ç¬¬å››ä¸ªç“¶é¢ˆï¼
â”‚ - è½®è¯¢é—´éš”ï¼š1-16ms                  â”‚
â”‚ - å®é™…ååï¼š10-15 KB/s             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    |
    â†“
Python Serial (ser.read())
```

## å…³é”®å‘ç°

### 1. Upload Arbiter FIFO = 128 å­—èŠ‚ï¼ˆå¤ªå°ï¼ï¼‰

**ä»£ç ä½ç½®**: `upload_arbiter_0.v:20`
```verilog
parameter FIFO_DEPTH = 128  // åªæœ‰128å­—èŠ‚ï¼
```

**readyä¿¡å·**: `upload_arbiter_0.v:72`
```verilog
assign src_upload_ready[i] = !fifo_full;
```

**é—®é¢˜**ï¼š
- å½“é‡‡æ ·ç‡10 kHzï¼ˆ10 KB/sï¼‰æ—¶
- 128å­—èŠ‚çš„FIFOåªèƒ½ç¼“å†²ï¼š128 bytes Ã· 10,000 bytes/s = **0.0128ç§’ = 12.8æ¯«ç§’**
- å¦‚æœä¸‹æ¸¸ï¼ˆUSB CDCï¼‰å»¶è¿Ÿè¶…è¿‡12.8msï¼ŒFIFOå°±æ»¡äº†
- Windows CDCé©±åŠ¨çš„è½®è¯¢é—´éš”æ˜¯1-16msï¼Œå¹³å‡10ms
- **æ‰€ä»¥Arbiter FIFOä¼šé¢‘ç¹æ»¡ï¼**

### 2. USB EP2_IN FIFO = 4 KB

**ä»£ç ä½ç½®**: `usb_fifo.v:45`
```verilog
`define EP2_IN_BUF_ASIZE 4'd12  // 2^12 = 4096 bytes
```

**ç¼“å†²æ—¶é—´**ï¼š
- 4096 bytes Ã· 10,000 bytes/s = **0.41ç§’ = 410æ¯«ç§’**

**çŠ¶æ€**ï¼šè¿™ä¸ªç¼“å†²è¶³å¤Ÿå¤§ï¼Œä¸æ˜¯ä¸»è¦ç“¶é¢ˆ

### 3. Command Processor = ç›´é€šï¼ˆæ— æµæ§ï¼‰

**ä»£ç ä½ç½®**: `command_processor.v:86`
```verilog
upload_ready_out <= 1'b1;  // æ°¸è¿œæ˜¯1
```

**é—®é¢˜**ï¼šCommand Processorä¸æä¾›èƒŒå‹ä¿¡å·ï¼Œåªæ˜¯ç›´é€šæ•°æ®

### 4. Windows CDC Driver = 10-15 KB/sï¼ˆæ ¹æœ¬ç“¶é¢ˆï¼‰

**è½®è¯¢æœºåˆ¶**ï¼š
- æ¯1-16msè½®è¯¢ä¸€æ¬¡ï¼ˆå¹³å‡10msï¼‰
- æ¯æ¬¡æœ€å¤š512å­—èŠ‚
- ç†è®ºååï¼š512 bytes Ã· 10ms = 51.2 KB/s
- å®é™…ååï¼š10-15 KB/sï¼ˆåè®®å¼€é”€ï¼‰

## ç“¶é¢ˆåˆ†æ

### åœºæ™¯ï¼š10 kHzé‡‡æ ·ï¼ˆ10 KB/sï¼‰

```
æ—¶é—´çº¿ï¼š  0ms     10ms    20ms    30ms    40ms
         |-------|-------|-------|-------|

DCäº§ç”Ÿ:  100B    100B    100B    100B    100B
         â†“       â†“       â†“       â†“       â†“

Arbiter: [ 50B ] [100B ] [æ»¡128B]
FIFO                        â†‘
                      upload_ready=0

USB:     [4KBå†…é€æ¸ç§¯ç´¯æ•°æ®]

Windows: [24KBå†…é€æ¸ç§¯ç´¯æ•°æ®]

æ¶ˆè´¹:    0B      512B    0B      512B    0B
         ^è½®è¯¢^  ^çªå‘^ ^è½®è¯¢^  ^çªå‘^ ^è½®è¯¢^
```

**å…³é”®æ—¶åˆ»**ï¼š
- **20msæ—¶**ï¼šArbiterçš„128å­—èŠ‚FIFOæ»¡ â†’ `upload_ready=0`
- Handleræ¥æ”¶åˆ°ready=0 â†’ æ²¡æœ‰å¤„ç†æœºåˆ¶ â†’ æ­»é”

**ä¸ºä»€ä¹ˆè¿™ä¹ˆå¿«å°±æ»¡ï¼Ÿ**
- ä¸æ˜¯å› ä¸ºæ€»ç¼“å†²åŒºæ»¡ï¼ˆæ€»å…±28KBè¿˜æœ‰ç©ºé—´ï¼‰
- è€Œæ˜¯å› ä¸º**Arbiterçš„128å­—èŠ‚FIFOå¤ªå°**ï¼
- å®ƒæ˜¯ç¬¬ä¸€çº§ç¼“å†²ï¼Œæœ€å…ˆæ»¡

## æ ¹æœ¬åŸå› å±‚æ¬¡

```
å±‚æ¬¡1ï¼šç›´æ¥åŸå› 
  â†“
HandlerçŠ¶æ€æœºç¼ºå°‘ready=0å¤„ç† â†’ æ­»é”

å±‚æ¬¡2ï¼šè§¦å‘æ¡ä»¶
  â†“
Arbiter FIFO (128å­—èŠ‚) å¤ªå° â†’ upload_readyé¢‘ç¹=0

å±‚æ¬¡3ï¼šæ·±å±‚åŸå› 
  â†“
USB CDCæ¶ˆè´¹é€Ÿç‡æ³¢åŠ¨ï¼ˆ10-15 KB/sï¼Œçªå‘æ€§ï¼‰

å±‚æ¬¡4ï¼šæ ¹æœ¬é™åˆ¶
  â†“
Windows CDCé©±åŠ¨è½®è¯¢æœºåˆ¶ï¼ˆ1-16msé—´éš”ï¼‰
```

## è§£å†³æ–¹æ¡ˆä¼˜å…ˆçº§

### ğŸŸ¢ æ–¹æ¡ˆ1ï¼šå¢å¤§Arbiter FIFOï¼ˆæ¨èï¼‰

**ä¿®æ”¹**: `upload_arbiter_0.v:20`
```verilog
parameter FIFO_DEPTH = 4096  // ä»128å¢åŠ åˆ°4096 (4KB)
```

**æ•ˆæœ**ï¼š
- ç¼“å†²æ—¶é—´ä»12.8mså¢åŠ åˆ°410ms
- å¯ä»¥å¹³æ»‘Windows CDCçš„çŸ­æœŸæ³¢åŠ¨
- **å¤§å¹…å‡å°‘upload_ready=0çš„é¢‘ç‡**

**ä¼˜ç‚¹**ï¼š
- âœ… æ ¹æœ¬æ€§æ”¹å–„æ•°æ®æµåŠ¨æ€§
- âœ… å‡å°‘ready=0çš„æƒ…å†µ
- âœ… æå‡æ•´ä½“ååç‡
- âœ… ä¿®æ”¹ç®€å•ï¼ˆæ”¹ä¸€ä¸ªå‚æ•°ï¼‰

**ç¼ºç‚¹**ï¼š
- âš ï¸ å¢åŠ FPGAèµ„æºæ¶ˆè€—ï¼ˆ4KB BRAMï¼‰
- âš ï¸ ä»ç„¶æ— æ³•çªç ´CDCçš„10-15 KB/sæé™

**èµ„æºè¯„ä¼°**ï¼š
- GW5A-25: æ€»BRAM 1.9 Mb = 243 KB
- å¢åŠ 4KB Ã— 4ä¸ªæº = 16 KB
- å ç”¨æ¯”ä¾‹ï¼š16/243 = 6.6%ï¼ˆå¯æ¥å—ï¼‰

### ğŸŸ¡ æ–¹æ¡ˆ2ï¼šå¢å¤§USB EP2_IN FIFOï¼ˆæ”¹å–„æœ‰é™ï¼‰

**ä¿®æ”¹**: `usb_fifo.v:45`
```verilog
`define EP2_IN_BUF_ASIZE 4'd13  // ä»12å¢åŠ åˆ°13 (2^13=8KB)
```

**æ•ˆæœ**ï¼š
- 4KB â†’ 8KBï¼Œå¢åŠ ä¸€å€
- ä½†ç”±äºArbiter FIFOåªæœ‰128å­—èŠ‚ï¼Œä»ç„¶ä¼šå¿«é€Ÿæ»¡
- **æ”¹å–„æœ‰é™**

### ğŸ”´ æ–¹æ¡ˆ3ï¼šä¿®å¤HandlerçŠ¶æ€æœºï¼ˆå¿…é¡»åšï¼‰

**å³ä½¿å¢å¤§FIFOï¼ŒHandlerä»ç„¶éœ€è¦æµæ§æœºåˆ¶**

```verilog
// digital_capture_handler.v:213-216
if (upload_ready) begin
    upload_valid <= 1'b1;
    upload_state <= UP_SEND;
end else begin
    new_sample_flag <= 1'b0;  // ä¸¢å¼ƒæ ·æœ¬ï¼Œé˜²æ­¢æ­»é”
end
```

**åŸå› **ï¼š
- å³ä½¿FIFOå†å¤§ï¼Œç†è®ºä¸Šä»å¯èƒ½æ»¡
- Handlerå¿…é¡»æœ‰å®¹é”™æœºåˆ¶
- è¿™æ˜¯æµå¼ç³»ç»Ÿçš„åŸºæœ¬è¦æ±‚

### ğŸŸ£ æ–¹æ¡ˆ4ï¼šæ”¹ç”¨USB Bulkæ›¿ä»£CDCï¼ˆé•¿æœŸæ–¹æ¡ˆï¼‰

**æ•ˆæœ**ï¼š
- ååç‡ï¼š10-30 MB/s
- å½»åº•è§£å†³CDCç“¶é¢ˆ

**ç¼ºç‚¹**ï¼š
- éœ€è¦é‡å†™USBéƒ¨åˆ†
- éœ€è¦è‡ªå®šä¹‰Windowsé©±åŠ¨
- å·¥ä½œé‡å·¨å¤§

## æ¨èå®æ–½é¡ºåº

### ç¬¬ä¸€æ­¥ï¼šå¢å¤§Arbiter FIFOï¼ˆç«‹å³å®æ–½ï¼‰
```verilog
// upload_arbiter_0.v:20
parameter FIFO_DEPTH = 4096  // 128 â†’ 4096
```

**é¢„æœŸæ•ˆæœ**ï¼š
- upload_ready=0çš„é¢‘ç‡å¤§å¹…é™ä½
- 10 kHzé‡‡æ ·ç‡ä¸‹ï¼Œå‡ ä¹ä¸ä¼šè§¦å‘ready=0
- å¯ä»¥æ”¯æŒåˆ°100 kHzå·¦å³

### ç¬¬äºŒæ­¥ï¼šä¿®å¤Handleræµæ§ï¼ˆç«‹å³å®æ–½ï¼‰
```verilog
// digital_capture_handler.v:213-216
if (upload_ready) begin
    upload_valid <= 1'b1;
    upload_state <= UP_SEND;
end else begin
    new_sample_flag <= 1'b0;
end
```

**é¢„æœŸæ•ˆæœ**ï¼š
- å³ä½¿FIFOæ»¡ï¼Œä¹Ÿä¸ä¼šæ­»é”
- æä¾›å®¹é”™æœºåˆ¶

### ç¬¬ä¸‰æ­¥ï¼šæµ‹è¯•å’Œä¼˜åŒ–
- æµ‹è¯•ä¸åŒé‡‡æ ·ç‡ï¼ˆ1K, 10K, 100K, 1Mï¼‰
- ç›‘æ§upload_readyçš„å˜åŒ–é¢‘ç‡
- å¦‚æœä»ç„¶ä¸å¤Ÿï¼Œè€ƒè™‘ç»§ç»­å¢å¤§FIFOæˆ–æ”¹ç”¨Bulkä¼ è¾“

## æ€§èƒ½é¢„æµ‹

### å½“å‰é…ç½®ï¼ˆ128å­—èŠ‚Arbiter FIFOï¼‰
| é‡‡æ ·ç‡ | çŠ¶æ€ | upload_ready=0é¢‘ç‡ |
|--------|------|-------------------|
| 1 kHz  | âœ… æ­£å¸¸ | å‡ ä¹ä¸ä¼š |
| 5 kHz  | âœ… æ­£å¸¸ | å¶å°” |
| 10 kHz | âŒ æ­»é” | é¢‘ç¹ï¼ˆæ¯20msï¼‰ |
| 100 kHz| âŒ å¿«é€Ÿæ­»é” | æŒç»­ |

### å¢å¤§åˆ°4KB Arbiter FIFOå
| é‡‡æ ·ç‡ | çŠ¶æ€ | upload_ready=0é¢‘ç‡ |
|--------|------|-------------------|
| 1 kHz  | âœ… æ­£å¸¸ | å‡ ä¹ä¸ä¼š |
| 5 kHz  | âœ… æ­£å¸¸ | å‡ ä¹ä¸ä¼š |
| 10 kHz | âœ… æ­£å¸¸ | å¾ˆå°‘ï¼ˆå¯èƒ½å¶å°”ï¼‰ |
| 100 kHz| âš ï¸ æœ‰ä¸¢åŒ… | ç»å¸¸ï¼ˆä½†ä¸æ­»é”ï¼‰ |

**100 kHzçš„é™åˆ¶**ï¼š
- 100 KB/sç”Ÿäº§é€Ÿç‡
- CDCåªæœ‰10-15 KB/sæ¶ˆè´¹é€Ÿç‡
- å³ä½¿4KB FIFOï¼Œä¹Ÿä¼šåœ¨40mså†…å¡«æ»¡
- ä½†æœ‰äº†Handleræµæ§ï¼Œä¸ä¼šæ­»é”ï¼Œåªä¼šä¸¢åŒ…
- é•¿æœŸå¹³å‡ååç‡ä»ç„¶æ˜¯10-15 KB/s

## ç»“è®º

ä½ çš„ç›´è§‰å®Œå…¨æ­£ç¡®ï¼é—®é¢˜çš„å…³é”®æ˜¯ï¼š

1. **Arbiterçš„128å­—èŠ‚FIFOå¤ªå°** â† è¿™æ˜¯å¯¼è‡´upload_readyé¢‘ç¹ä¸º0çš„ç›´æ¥åŸå› 
2. **Handlerç¼ºå°‘æµæ§æœºåˆ¶** â† è¿™æ˜¯å¯¼è‡´æ­»é”çš„ç›´æ¥åŸå› 
3. **CDCåè®®é™åˆ¶** â† è¿™æ˜¯ååç‡ä¸Šé™çš„æ ¹æœ¬åŸå› 

**æœ€ä½³ç­–ç•¥**ï¼š
- âœ… å¢å¤§Arbiter FIFOåˆ°4KBï¼ˆè§£å†³readyé¢‘ç¹ä¸º0ï¼‰
- âœ… ä¿®å¤Handleræµæ§ï¼ˆè§£å†³æ­»é”ï¼‰
- âš ï¸ CDCååç‡é™åˆ¶ä»ç„¶å­˜åœ¨ï¼ˆ10-15 KB/sä¸Šé™ï¼‰

**å¦‚æœä½ çš„æœ€ç»ˆç›®æ ‡æ˜¯æœ€å¤§åŒ–CDCé€Ÿç‡**ï¼š
- å¢å¤§FIFOå¯ä»¥è®©ä½ æ¥è¿‘CDCçš„10-15 KB/sæé™
- ä½†æ— æ³•çªç ´è¿™ä¸ªæé™
- è¦çªç ´å¿…é¡»æ”¹ç”¨USB Bulkä¼ è¾“
