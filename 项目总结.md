# FPGA2025 多协议通信Hub项目详细总结

## 一、项目概述

### 1.1 项目定位
FPGA2025是一个基于**高云GW5A-25A FPGA**（GW5A-LV25UG324C2/I1）的多协议通信中心与信号生成系统。该项目实现了一个功能完整的FPGA实验平台，支持多种通信协议和信号测量/生成功能。

### 1.2 核心特性
- **USB CDC接口**：作为与上位机通信的主要接口，支持高速数据传输
- **多协议支持**：集成UART、I2C、SPI、1-Wire、以太网等常用通信协议
- **双通道ADC采集**：基于AD9238的双通道14位高速ADC数据采集，支持DDR采样
- **信号生成**：双通道DAC输出、8通道PWM、DDS信号发生器、自定义波形生成
- **信号测量**：双通道ADC采集、数字信号测量（DSM）、8通道数字逻辑分析仪（LA）
- **以太网扩展**：支持RGMII以太网接口及DDR3缓存
- **统一协议框架**：基于帧结构的指令系统，易于扩展

### 1.3 目标器件
- **FPGA芯片**：GOWIN GW5A-25A
- **封装**：UG324C2/I1
- **主时钟**：60MHz系统时钟
- **开发工具**：GOWIN EDA + ModelSim仿真

---

## 二、系统架构

### 2.1 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                         USB CDC 接口                          │
│                      (主机通信入口)                            │
└──────────────┬──────────────────────────────────────────────┘
               │
               ▼
┌──────────────────────────────────────────────────────────────┐
│              Protocol Parser (协议解析器)                      │
│   帧格式: 0xAA55 | CMD | LEN | DATA | CHECKSUM               │
└──────────────┬───────────────────────────────────────────────┘
               │
               ▼
┌──────────────────────────────────────────────────────────────┐
│           Command Processor (指令处理器)                       │
│            数据驱动架构 + 统一指令分发                          │
└──┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬──────────────┘
   │   │   │   │   │   │   │   │   │   │   │   │
   ▼   ▼   ▼   ▼   ▼   ▼   ▼   ▼   ▼   ▼   ▼   ▼
┌────────────────────────────────────────────────────────────┐
│                    功能模块层                                │
├──────────┬──────────┬──────────┬──────────┬────────────────┤
│ UART     │ I2C      │ SPI      │ 1-Wire   │ PWM (8ch)      │
│ Handler  │ Handler  │ Handler  │ Handler  │ Handler        │
├──────────┼──────────┼──────────┼──────────┼────────────────┤
│ DAC (2ch)│ DDS      │ Custom   │ ADC(2ch) │ DSM      │ Digital│
│ Handler  │ Gen      │ Waveform │ Capture  │ (8ch)    │ Capture(8ch)│
├──────────┴──────────┴──────────┴──────────┴────────────────┤
│              以太网模块 (Ethernet + DDR3)                     │
└──────────────────────────────────────────────────────────────┘
               │
               ▼
┌──────────────────────────────────────────────────────────────┐
│              Upload Arbiter (上传仲裁器)                       │
│         多通道数据上传 + 优先级调度                            │
└──────────────┬───────────────────────────────────────────────┘
               │
               ▼
┌──────────────────────────────────────────────────────────────┐
│            USB CDC TX FIFO (返回上位机)                       │
└──────────────────────────────────────────────────────────────┘
```

### 2.2 数据流向

#### 下行指令流（Host → FPGA）
```
USB CDC → Protocol Parser → Command Processor → 功能模块
```

#### 上行数据流（FPGA → Host）
```
功能模块 → Upload Arbiter → Upload Packer → USB CDC TX
```

### 2.3 时钟域架构

| 时钟域 | 频率 | 用途 |
|--------|------|------|
| `clk` | 60MHz | 系统主时钟（逻辑控制） |
| `CLK24M` | 24MHz | USB PHY时钟 |
| `fclk_480M` | 480MHz | USB高速通信 |
| `clk200m` | 200MHz | 以太网PHY |
| `ad_ddr_clk_400m` | 400MHz | DDR3控制器 |
| `adc_sample_clk` | 120MHz | ADC/DAC采样时钟 |
| `rgmii_rx_clk` | 125MHz | 以太网接收时钟 |

**时钟资源由多个PLL生成**：
- `Gowin_PLL_24`：生成24MHz USB时钟
- `ad_ddr_eth_pll`：生成DDR/以太网所需时钟
- `gowin_pll`：生成系统主时钟

---

## 三、通信协议详解

### 3.1 帧结构定义

#### 下行指令帧格式（Host → FPGA）
```
┌──────┬──────┬──────┬──────────┬─────────────┬──────────┐
│ 帧头  │ 功能码│ 长度  │  数据体   │   校验和     │
├──────┼──────┼──────┼──────────┼─────────────┤
│ 0xAA │ 0x55 │ CMD  │ LEN_H    │ LEN_L       │ DATA[0..N]│ CHECKSUM │
│  (固定)     │ 1B   │ 2B (大端) │ 0-65535字节  │ 1B       │
└──────┴──────┴──────┴──────────┴─────────────┴──────────┘
```

#### 上行数据帧格式（FPGA → Host）
```
┌──────┬──────┬──────────┬──────────┬─────────────┬──────────┐
│ 帧头  │数据源 │  长度     │  数据体   │   校验和     │
├──────┼──────┼──────────┼──────────┼─────────────┤
│ 0xAA │ 0x44 │ SOURCE   │ LEN_H    │ LEN_L       │ DATA[0..N]│ CHECKSUM │
│  (固定)     │ 1B       │ 2B (大端) │ 0-65535字节  │ 1B       │
└──────┴──────┴──────────┴──────────┴─────────────┴──────────┘
```

**特殊说明**：
- **数字逻辑捕获（0x0B）** 使用**直通模式**，无协议头，直接输出原始采样字节流
- 校验和计算范围：从**功能码/数据源**字节开始到**数据体结束**（不包含帧头0xAA55/0xAA44）

### 3.2 功能码定义

| 功能码 | 功能描述 | 状态 |
|--------|---------|------|
| 0x02 | I2C_NO_ADDR发送 | ✅ |
| 0x03 | I2C_NO_ADDR接收 | ✅ |
| 0x04 | I2C配置（地址+频率） | ✅ |
| 0x05 | I2C发送数据 | ✅ |
| 0x06 | I2C接收数据 | ✅ |
| 0x07 | UART配置（波特率、数据位、停止位、校验） | ✅ |
| 0x08 | UART发送数据 | ✅ |
| 0x09 | UART接收数据 | ✅ |
| 0x0A | 数字信号测量（DSM，8通道） | ✅ |
| 0x0B | 数字逻辑捕获启动（8通道LA） | ✅ |
| 0x0C | 数字逻辑捕获停止 | ✅ |
| 0x11 | SPI读写操作 | ✅ |
| 0x14 | I2C从机配置地址 | 🚧 |
| 0x15 | I2C从机写数据 | 🚧 |
| 0x16 | I2C从机读数据 | 🚧 |
| 0x20 | 1-Wire复位 | ✅ |
| 0x21 | 1-Wire写字节 | ✅ |
| 0x22 | 1-Wire读字节 | ✅ |
| 0x23 | 1-Wire写读操作 | ✅ |
| 0xFC | 自定义波形上传 | ✅ |
| 0xFD | DAC配置（双通道） | ✅ |
| 0xFE | PWM配置（8通道） | ✅ |
| 0xFF | 心跳测试 | ✅ |

### 3.3 数据源标识（上传数据）

| 数据源 | 标识 | 说明 |
|--------|------|------|
| UART | 0x01 | 外部UART接收数据 |
| SPI | 0x03 | SPI读取数据 |
| 1-Wire | 0x04 | 1-Wire读取数据 |
| DSM | 0x0A | 数字信号测量数据 |
| Digital Capture | 0x0B | 数字逻辑捕获（直通模式） |

---

## 四、核心模块详解

### 4.1 USB CDC接口模块

**位置**：`rtl/usb/`

**核心IP**：
- `usb2_0_softphy`：USB 2.0软PHY
- `usb_device_controller`：USB设备控制器

**功能**：
- 实现USB CDC类设备
- 提供虚拟串口功能
- 支持全速USB 2.0通信（12Mbps）
- 24MHz时钟驱动

**接口信号**：
```verilog
inout usb_dxp_io, usb_dxn_io          // USB差分数据线
input usb_rxdp_i, usb_rxdn_i          // USB接收数据
output usb_pullup_en_o                // USB上拉使能
```

### 4.2 协议解析器 (Protocol Parser)

**位置**：`rtl/protocol_parser.v`

**功能**：
1. 检测帧头（0xAA55）
2. 提取功能码、长度、数据体
3. 计算并验证校验和
4. 将数据体存入Payload RAM供指令处理器读取

**状态机**：
```
S_IDLE → S_SOF2 → S_CMD → S_LEN_H → S_LEN_L → S_PAYLOAD → S_CHECKSUM
```

**关键参数**：
- `MAX_PAYLOAD_LEN = 256`：最大支持256字节数据体（可扩展到65535）

### 4.3 指令处理器 (Command Processor)

**位置**：`rtl/command_processor.v`

**设计模式**：**数据驱动架构**

**工作流程**：
1. 检测到`parse_done`信号
2. 读取功能码和长度
3. 逐字节从Payload RAM读取数据
4. 通过统一接口输出到各功能模块
5. 接收功能模块的状态反馈

**统一指令接口**：
```verilog
output reg [7:0]  cmd_type_out        // 功能码
output reg [15:0] cmd_length_out      // 数据长度
output reg [7:0]  cmd_data_out        // 当前数据字节
output reg [15:0] cmd_data_index_out  // 数据索引
output reg        cmd_start_out       // 指令开始脉冲
output reg        cmd_data_valid_out  // 数据有效
output reg        cmd_done_out        // 指令完成
input wire        cmd_ready_in        // 功能模块就绪反馈
```

**状态机**（考虑RAM 2周期读延迟）：
```
IDLE → SET_ADDR → WAIT_DATA_1 → WAIT_DATA_2 → GET_DATA
```

### 4.4 UART模块

**位置**：`rtl/uart/`

**核心文件**：
- `uart.v`：UART核心收发器
- `usb_uart_config.v`：可配置波特率/数据位/停止位/校验
- `fixed_point_divider/`：定点除法器（用于波特率计算）

**支持配置**：
- 波特率：任意（通过32位整数指定，如9600、115200）
- 数据位：5/6/7/8
- 停止位：1/1.5/2
- 校验：无/奇/偶

**配置示例（0x07功能码）**：
```python
# 115200波特率，8N1配置
data = [
    0x00, 0x01, 0xC2, 0x00,  # 波特率115200（大端）
    0x08,                     # 8数据位
    0x00,                     # 1停止位
    0x00                      # 无校验
]
```

### 4.5 I2C模块

**位置**：`rtl/i2c/`

**支持模式**：
- **I2C主机**：支持50kHz/100kHz/200kHz/400kHz
- **I2C从机**：支持作为从设备（功能受限）

**核心功能**：
1. 配置从机地址和时钟频率（0x04）
2. 写寄存器：发送地址+数据（0x05）
3. 读寄存器：发送地址，接收数据（0x06）
4. 无地址模式：直接读写（0x02/0x03）

**测试模型**：
- `M24LC04B.v`、`M24LC64.v`：仿真用EEPROM模型

### 4.6 SPI模块

**位置**：`rtl/spi/`

**核心文件**：
- `spi_master.v`：SPI主机核心
- `spi_handler.v`：SPI指令处理逻辑
- `simple_spi_master.v`：简化版SPI控制器

**支持操作（0x11功能码）**：
```
写长度 (1B) | 读长度 (1B) | 发送数据 (0-255B)
```

**工作模式**：
- 先发送write_len字节
- 再接收read_len字节
- 支持只写、只读、写后读三种模式

**示例**：
```python
# 写2字节0xABCD，读1字节
data = [0x02, 0x01, 0xAB, 0xCD]
# 响应: 0xAA44 | 0x03 | 0x0001 | [读取的1字节] | 校验和
```

### 4.7 1-Wire模块

**位置**：`rtl/one_wire/`

**核心文件**：
- `one_wire_master.v`：1-Wire总线主机实现
- `one_wire_handler.v`：指令处理逻辑

**支持操作**：
- **复位**（0x20）：发送复位脉冲，检测应答
- **写字节**（0x21）：发送数据字节（LSB先行）
- **读字节**（0x22）：接收数据字节
- **写读操作**（0x23）：先写后读（最常用）

**典型应用：DS18B20温度传感器**
```
1. 复位 (0x20)
2. Skip ROM (0x21, 数据0xCC)
3. Convert T (0x21, 数据0x44)
4. 等待750ms
5. 复位 (0x20)
6. Skip ROM (0x21, 数据0xCC)
7. 读暂存器 (0x23, 写1字节0xBE, 读9字节)
8. 解析温度 = (MSB << 8 | LSB) / 16.0
```

### 4.8 PWM模块

**位置**：`rtl/pwm/`

**核心文件**：
- `pwm.v`：单通道PWM生成器
- `pwm_handler.v`：8通道PWM管理器

**配置参数（0xFE功能码）**：
```
通道号 (1B) | 周期 (2B, ns) | 占空比 (2B, ns)
```

**支持通道**：8路独立PWM输出（`pwm_pins[7:0]`）

**精度**：纳秒级时序控制

**Python工具**：
```bash
python software/pwm_command_generator.py -c 0 -f 1000 -d 50
# 生成通道0，频率1kHz，占空比50%的指令
```

### 4.9 DAC与DDS模块

**位置**：`rtl/dds/`

**核心文件**：
- `DDS.v`：DDS核心（直接数字频率合成）
- `Sin.v`：正弦波查找表
- `accuml.v`：相位累加器
- `custom_wave_sdpb/`：自定义波形RAM（双端口BRAM）

**双通道DAC输出**：
```verilog
output [13:0] dac_data_a_out  // 通道A，14位分辨率
output [13:0] dac_data_b_out  // 通道B，14位分辨率
output dac_clk_a_out          // DAC时钟A (120MHz)
output dac_clk_b_out          // DAC时钟B (120MHz)
```

#### DAC配置（0xFD功能码）
```
通道号 (1B) | 波形类型 (1B) | 频率字 (4B) | 相位字 (4B)
```

**波形类型**：
- 0：正弦波
- 1：三角波
- 2：锯齿波
- 3：方波
- 4：梯形波

**频率字计算**：
```
fre_word = (目标频率 × 2^32) / DAC时钟频率
示例：生成1MHz信号，DAC时钟200MHz
fre_word = (1MHz × 4294967296) / 200MHz = 21474836
```

**相位字计算**：
```
pha_word = (目标相位角度 × 2^32) / 360°
示例：90度相位
pha_word = (90 × 4294967296) / 360 = 1073741824
```

#### 自定义波形上传（0xFC功能码）

**数据格式**：
```
控制字 (1B) | 波形长度 (2B) | 采样率字 (4B) | 波形数据 (N×2B)
```

**控制字定义**：
- Bit[1:0]：操作模式
  - `00`：写入新波形
  - `01`：追加数据（分包传输）
  - `10`：启动播放
  - `11`：停止播放
- Bit[2]：循环模式（0=单次，1=循环）
- Bit[3]：通道选择（0=通道A，1=通道B）
- Bit[7:4]：保留

**波形数据编码**：
- 每个采样点14位，范围0x0000-0x3FFF
- 0x0000：最小电压
- 0x2000：零点（中间电压）
- 0x3FFF：最大电压
- 每个采样点打包为2字节（小端）

**采样率字计算**：
```
sample_rate_word = round((波形播放频率 × 2^20) / DAC时钟频率)

示例：256点波形，输出1kHz信号
波形播放频率 = 1kHz × 256 = 256kHz
sample_rate_word = (256kHz × 1048576) / 120MHz = 2241
```

**Python工具**：
```bash
python software/custom_waveform_tool.py --generate sine --length 256 --frequency 1000
```

### 4.10 数字信号测量模块 (DSM)

**位置**：`rtl/digital_signal_measure.v`

**功能**：测量数字信号的频率、占空比、周期

**输入通道**：8路数字信号（`dsm_signal_in[7:0]`）

**指令格式（0x0A功能码）**：
```
通道掩码 (1B)：Bit[7:0]对应通道7-0，1=启用测量
```

**响应数据**（每个启用通道返回9字节）：
```
通道号 (1B) | 高电平时间 (2B) | 低电平时间 (2B) | 周期时间 (2B) | 占空比 (2B)
```

**时间单位**：时钟周期（60MHz系统时钟，即16.67ns）

**占空比单位**：百分比×100（例如5000表示50.00%）

**示例**：
```python
# 启用通道0和2测量
mask = 0x05  # 二进制00000101
# 响应18字节：通道0的9字节 + 通道2的9字节
```

### 4.11 数字逻辑捕获模块 (Digital Capture)

**位置**：`rtl/logic/digital_capture_handler.v`

**功能**：8通道数字逻辑分析仪，实时采样上传

**输入通道**：8路数字信号（`dc_signal_in[7:0]`）

**启动指令（0x0B功能码）**：
```
分频高字节 (1B) | 分频低字节 (1B)
```

**采样率计算**：
```
采样率 = 系统时钟频率 / 分频系数 = 60MHz / divider

示例：
- 1MHz采样: divider = 60
- 500kHz采样: divider = 120
- 100kHz采样: divider = 600
```

**数据格式（直通模式）**：
- **无协议头**，直接输出原始字节流
- 每字节对应一个采样时刻
- Bit[7:0] = [CH7, CH6, CH5, CH4, CH3, CH2, CH1, CH0]
- 1=高电平，0=低电平

**停止指令（0x0C功能码）**：
```
无数据体
```

**限制**：
- 最大采样率：1.2MHz（divider=50）
- 推荐采样率：≤1MHz
- 最小分频系数：50
- 最大分频系数：65535

**重要提示**：
- 启动后USB带宽被占用
- 必须发送STOP命令才能停止
- 采集期间其他模块上传可能受影响

**Python工具**：
```bash
python software/dc_command_tool.py start --rate 1000000  # 启动1MHz采样
python software/dc_realtime_viewer.py                    # 实时查看器
python software/dc_command_tool.py stop                  # 停止采样
```

### 4.12 以太网模块

**位置**：`rtl/eth/`

**核心组件**：
- `eth_udp_gmii/`：UDP/IP协议栈（GMII接口）
- `gmii_rgmii_gmii/`：GMII-RGMII转换
- `ddr3_memory_interface/`：DDR3内存接口
- `ddr3_ctrl_2port/`：双端口DDR3控制器
- `eth_cmd.v`：以太网命令处理

**物理接口**：RGMII（1Gbps以太网）
```verilog
input rgmii_rx_clk_i          // 接收时钟
input [3:0] rgmii_rxd         // 接收数据
input rgmii_rxdv              // 接收数据有效
output rgmii_tx_clk           // 发送时钟
output [3:0] rgmii_txd        // 发送数据
output rgmii_txen             // 发送使能
```

**DDR3接口**：
- 支持DDR3 SDRAM缓存
- 400MHz控制器时钟
- 16位数据位宽
- 双端口访问

**网络功能**：
- UDP/IP数据包收发
- MAC地址配置
- IP地址配置
- ARP协议支持

### 4.13 数据上传仲裁器 (Upload Arbiter)

**位置**：`rtl/upload_arbiter.v`、`rtl/upload_arbiter_0.v`

**功能**：多源数据上传优先级调度

**数据源优先级**：
1. UART接收数据（0x01）
2. SPI读取数据（0x03）
3. 1-Wire读取数据（0x04）
4. DSM测量数据（0x0A）
5. Digital Capture（0x0B，直通模式）

**工作原理**：
- 轮询各数据源的上传请求
- 按优先级选择当前服务的源
- 添加帧头、数据源标识、长度、校验和
- 输出到USB CDC TX FIFO

**相关模块**：
- `upload_adapter_0.v`：数据格式适配器
- `upload_packer_0.v`：协议帧封装器

### 4.14 双通道ADC采集模块

**位置**：`rtl/eth/adc_driver.sv`、`rtl/eth/ad9238_12bit_to_16bit.sv`

**芯片型号**：AD9238（双通道14位高速ADC）

**核心文件**：
- `adc_driver.sv`：ADC接口驱动（DDR数据采集）
- `ad9238_12bit_to_16bit.sv`：ADC数据处理与通道选择

**硬件接口**：
```verilog
input [13:0] adc_data_in       // 14位ADC数据输入
output adc_clk_out             // ADC采样时钟输出（DDR转发）
output adc_mux_select          // 通道多路复用选择信号
```

#### ADC驱动特性

**DDR采样技术**：
- 使用ODDR原语生成ADC时钟
- 使用IDDR原语双沿采样数据
- 同时捕获两个通道的数据（adc_data_a、adc_data_b）

**时钟配置**：
- `clk_ddr`：DDR输出时钟（用于生成ADC采样时钟）
- `clk_sample`：采样时钟（120MHz ADC采样时钟）
- `adc_clk_out`：转发到ADC的时钟信号

**数据路径**：
```
ADC芯片 → IDDR采样 → 数据寄存 → adc_data_a/b → 数据处理
```

#### 通道选择模式

**ch_sel配置**（2位控制）：

| ch_sel | 模式 | 说明 |
|--------|------|------|
| 2'b00 | 测试模式 | 输出递增测试数据 |
| 2'b01 | 通道A | 仅输出通道A数据（ad_in1） |
| 2'b10 | 通道B | 仅输出通道B数据（ad_in2） |
| 2'b11 | 双通道交替 | 交替输出通道A和B数据 |

**数据格式**：
- 输入：14位二进制补码（有符号数）
- 输出：16位数据（高2位补零，低14位为ADC数据）
- 数据范围：0x0000 - 0x3FFF（14位）

#### 数据流控制

**使能信号**：
- `ad_data_en`：数据使能信号，高电平时开始采集
- `ad_out_valid`：数据输出有效信号

**双通道交替模式工作流程**：
1. 捕获通道A和B的数据（pair_sample、next_sample）
2. 第一个时钟输出通道A数据
3. 第二个时钟输出通道B数据
4. 循环往复

**数据位宽转换**：
- ADC原始数据：14位
- 输出数据：16位（{2'b00, adc_data[13:0]}}）
- 便于后续处理和对齐

#### 集成方式

ADC模块集成在以太网子系统中（`acm9238_ddr3_rgmii.v`），可通过以太网接口高速传输采集数据到DDR3缓存，再通过网络上传到上位机。

**应用场景**：
- 高速信号采集
- 双通道示波器功能
- 信号分析与处理
- 数据记录与回放

**采样率**：
- 最高采样率：120 MSPS（受采样时钟限制）
- 双通道同时采样
- DDR技术实现高速数据捕获

**限制**：
- 当前主要集成在以太网模块中
- 通过以太网+DDR3实现高速数据缓存
- USB CDC接口带宽可能不足以支持最高采样率实时传输

---

## 五、仿真环境

### 5.1 仿真工具

**ModelSim**：主要仿真工具

**仿真工程位置**：`sim/`

**脚本驱动**：所有仿真使用`.do`脚本

### 5.2 主要仿真工程

#### 5.2.1 CDC Testbench
**位置**：`sim/cdc_tb/`

**用途**：测试USB CDC通信和协议解析

**运行**：
```bash
modelsim -do sim/cdc_tb/cmd.do
```

#### 5.2.2 DDS Testbench
**位置**：`sim/dds_tb/`

**用途**：测试DDS信号生成器

**运行**：
```bash
modelsim -do sim/dds_tb/cmd.do
```

#### 5.2.3 其他Testbench
**位置**：`tb/`

**测试文件**：
- `digital_signal_measure_tb.v`：DSM模块测试
- `digital_capture_handler_tb.v`：数字捕获测试
- `one_wire_master_tb.v`：1-Wire主机测试
- `one_wire_handler_tb.v`：1-Wire处理器测试
- `spi_handler_tb.v`：SPI处理器测试
- `upload_arbiter_tb.v`：上传仲裁器测试
- `upload_packer_tb.v`：协议封装器测试
- `upload_integration_tb.v`：上传系统集成测试
- `upload_full_integration_tb.v`：完整系统集成测试

### 5.3 仿真规范

**规范要求**：
1. 每个模块对应一个仿真工程
2. 测试新模块时在`sim/`下新建工程
3. 仿真必须使用`.do`脚本自动化
4. 不提交仿真生成的临时文件

---

## 六、上位机软件工具

### 6.1 Python工具集

**位置**：`software/`

#### 6.1.1 PWM工具
**文件**：`pwm_command_generator.py`

**功能**：生成PWM配置指令

**用法**：
```bash
python pwm_command_generator.py -c <通道> -f <频率> -d <占空比>

示例：
python pwm_command_generator.py -c 0 -f 1000 -d 50
# 通道0，1kHz，50%占空比
```

#### 6.1.2 UART工具
**文件**：`uart_command.py`

**功能**：生成UART配置/收发指令

**用法**：
```bash
# 配置UART
python uart_command.py config --baud 115200 --data-bits 8 --stop-bits 0 --parity 0

# 发送数据
python uart_command.py tx "Hello World"

# 接收数据
python uart_command.py rx
```

#### 6.1.3 SPI工具
**文件**：`spi_command.py`、`spi_loopback_test.py`、`oled_spi_test.py`

**功能**：
- `spi_command.py`：生成SPI读写指令
- `spi_loopback_test.py`：SPI回环测试
- `oled_spi_test.py`：OLED屏幕SPI测试

#### 6.1.4 1-Wire工具
**文件**：`one_wire_test.py`

**功能**：DS18B20温度传感器测试

#### 6.1.5 I2C工具
**文件**：`i2c_command_tool.py`

**功能**：I2C配置和读写操作

#### 6.1.6 DAC/DDS工具
**文件**：`dac_command_generator.py`、`custom_waveform_tool.py`

**功能**：
- `dac_command_generator.py`：生成DAC配置指令
- `custom_waveform_tool.py`：生成自定义波形数据

**用法**：
```bash
# 生成正弦波
python custom_waveform_tool.py --generate sine --length 256 --frequency 1000

# 生成三角波
python custom_waveform_tool.py --generate triangle --length 128 --frequency 500
```

#### 6.1.7 数字逻辑分析工具
**文件**：`dc_command_tool.py`、`dc_realtime_viewer.py`、`diagnose_dc.py`

**功能**：
- `dc_command_tool.py`：数字捕获控制
- `dc_realtime_viewer.py`：实时波形查看器
- `diagnose_dc.py`：诊断工具

**用法**：
```bash
# 启动1MHz采样
python dc_command_tool.py start --rate 1000000

# 实时查看
python dc_realtime_viewer.py

# 停止采样
python dc_command_tool.py stop
```

---

## 七、设计特色与技术亮点

### 7.1 数据驱动架构

**核心思想**：
- 中心化的指令分发器
- 统一的模块接口
- 松耦合的模块设计

**优势**：
- 易于扩展新功能
- 模块间互不干扰
- 代码复用率高

### 7.2 FIFO流水线设计

**应用场景**：
- USB收发数据缓冲
- UART收发FIFO
- 以太网数据包缓存
- 数字捕获数据流

**优势**：
- 平滑不同时钟域
- 缓解瞬时流量
- 提高系统稳定性

### 7.3 状态机控制模式

**广泛应用**：
- 协议解析状态机
- 指令处理状态机
- I2C时序控制
- SPI传输控制
- 1-Wire总线控制

**设计规范**：
- 清晰的状态转移
- 完善的错误处理
- 可复位到初始状态

### 7.4 模块化设计

**目录组织**：
```
rtl/
├── clk/           # 时钟管理
├── usb/           # USB接口
├── uart/          # UART模块
├── i2c/           # I2C模块
├── spi/           # SPI模块
├── one_wire/      # 1-Wire模块
├── pwm/           # PWM模块
├── dds/           # DDS/DAC模块
├── eth/           # 以太网模块
└── logic/         # 数字测量/捕获
```

**接口规范**：
- 统一的指令接口
- 统一的上传接口
- 统一的时钟复位

### 7.5 时钟域跨越处理

**技术手段**：
- 双触发器同步
- 异步FIFO
- 握手协议
- 格雷码转换

**关键模块**：
- USB CDC（24MHz ↔ 60MHz）
- 以太网（125MHz ↔ 60MHz）
- DDR3（400MHz ↔ 60MHz）
- ADC/DAC（120MHz ↔ 60MHz）

---

## 八、约束文件

### 8.1 引脚约束

**文件**：`constraints/pin_cons.cst`

**主要约束内容**：
- USB接口引脚
- 以太网RGMII引脚
- DDR3接口引脚
- DAC/ADC接口引脚
- PWM输出引脚
- I2C/SPI/UART/1-Wire引脚
- DSM/DC输入引脚
- LED指示灯

### 8.2 时序约束

**包含内容**：
- 时钟周期约束
- 输入/输出延迟约束
- 时钟组约束（异步时钟）
- 跨时钟域路径约束

---

## 九、构建与烧录

### 9.1 打开工程

**工程文件**：`fpga_project.gprj`

**工具**：GOWIN EDA IDE

### 9.2 构建流程

1. **综合（Synthesis）**：将Verilog代码转换为网表
2. **布局布线（Place & Route）**：映射到FPGA资源
3. **生成比特流（Generate Bitstream）**：生成`.fs`烧录文件

**构建方式**：GUI操作（无命令行构建脚本）

### 9.3 烧录

**方式**：
- 通过GOWIN Programmer烧录
- 支持JTAG/SPI Flash烧录
- 支持在线调试

---

## 十、文档

### 10.1 核心文档

**位置**：`doc/`

**文件**：
- `USB-CDC通信协议.md`：完整协议规范文档（585行）

**内容**：
- 帧格式定义
- 功能码详解
- 每个指令的数据格式和示例
- 响应数据格式
- 校验和计算方法
- 典型应用流程

### 10.2 代码注释

**特点**：
- 模块头部包含作者、日期、功能描述
- 关键逻辑有注释说明
- 状态机状态清晰标注

---

## 十一、开发规范

### 11.1 Git工作流

**分支策略**：
- `watermeko`：当前开发分支
- `hee-usb-fix`：USB修复分支
- 主分支未明确（建议`main`或`master`）

**提交规范**：
- 使用有意义的commit信息
- 使用标签标注类型（如`[FIX]`、`[ADD]`、`[UPDATE]`）

**示例**：
```
[FIX]Fix dc glitch.
[FIX]Fix I2C slave timing issue.
Optimize USB CDC FIFO sizes to reduce BRAM usage
```

### 11.2 .gitignore规则

**排除内容**：
- `impl/`：综合结果
- `gowin_ip/`：IP临时文件
- `temp/`：临时文件
- 仿真生成的临时文件

**注意**：
- 在自己分支上按需修改`.gitignore`
- 不要提交无用文件

### 11.3 代码组织

**规范**：
1. 每个模块对应一个仿真工程
2. `tb/`、`rtl/`目录下可新建文件夹组织代码
3. 仿真工程必须使用`.do`脚本
4. 保持目录结构清晰

---

## 十二、已知问题与改进方向

### 12.1 已知限制

1. **I2C从机模式**：功能不完整，无法作为调试器使用（仅能单向通信）
2. **数字逻辑捕获**：最大采样率1.2MHz，受USB CDC带宽限制
3. **ADC高速采集**：USB CDC接口带宽不足以支持120MSPS实时传输，需通过以太网+DDR3缓存
4. **以太网功能**：代码已实现，但集成测试不充分
5. **DDR3缓存**：未充分利用，可用于高速数据缓冲

### 12.2 改进方向

1. **性能优化**：
   - 提高数字捕获采样率（使用DMA或DDR缓存）
   - 优化USB CDC传输效率
   - 完善ADC数据的USB上传通路（降低采样率或使用压缩）

2. **功能扩展**：
   - 完善ADC数据的USB CDC上传接口（添加功能码支持）
   - 完善I2C从机功能
   - 增加CAN总线支持
   - 增加更多波形类型（任意波形生成器）

3. **易用性提升**：
   - 开发图形化上位机软件
   - 增加Web配置界面（通过以太网）
   - 提供更多示例代码和教程

4. **稳定性改进**：
   - 完善错误处理机制
   - 增加硬件看门狗
   - 优化时序约束

---

## 十三、快速上手指南

### 13.1 硬件准备

1. GOWIN GW5A-25A开发板
2. USB线（连接USB CDC接口）
3. 测试外设（传感器、OLED等）

### 13.2 软件准备

1. 安装GOWIN EDA（综合、布局布线、烧录）
2. 安装ModelSim（可选，用于仿真）
3. 安装Python 3.x（运行上位机工具）
4. 安装串口调试工具

### 13.3 第一次运行

1. **打开工程**：
   ```
   用GOWIN EDA打开 fpga_project.gprj
   ```

2. **构建**：
   ```
   综合 → 布局布线 → 生成比特流
   ```

3. **烧录**：
   ```
   使用GOWIN Programmer烧录到FPGA
   ```

4. **连接USB**：
   - 将FPGA通过USB CDC接口连接到PC
   - 识别为虚拟串口（如COM3或/dev/ttyACM0）

5. **测试心跳**：
   ```python
   import serial

   ser = serial.Serial('COM3', 115200)
   # 发送心跳指令: 0xAA55 | 0xFF | 0x0000 | 0xFF
   ser.write(bytes([0xAA, 0x55, 0xFF, 0x00, 0x00, 0xFF]))
   response = ser.read(7)  # 期望收到: 0xAA44 | 0xFF | 0x0000 | 0xFF
   print(response.hex())
   ```

6. **运行示例**：
   ```bash
   # PWM输出
   python software/pwm_command_generator.py -c 0 -f 1000 -d 50

   # 数字信号测量
   python software/diagnose_dc.py

   # DAC波形生成
   python software/dac_command_generator.py
   ```

---

## 十四、总结

**FPGA2025**是一个功能丰富、架构清晰的**多协议通信与信号生成平台**。项目具有以下特点：

### 优势：
✅ **模块化设计**：各功能模块独立，易于维护和扩展
✅ **统一协议**：基于帧结构的指令系统，简洁高效
✅ **数据驱动架构**：中心化指令分发，松耦合模块连接
✅ **完善的仿真环境**：ModelSim仿真+Python测试工具
✅ **丰富的接口**：支持UART/I2C/SPI/1-Wire/以太网等常用协议
✅ **双通道DAC**：支持预定义波形和自定义波形生成
✅ **8通道PWM**：纳秒级精度
✅ **数字测量/捕获**：8通道信号测量+逻辑分析仪
✅ **详细文档**：完整的协议规范和代码注释

### 应用场景：
🔧 **嵌入式系统调试**：作为多协议调试器
🔬 **信号生成与测试**：函数发生器、PWM驱动器
📊 **数字逻辑分析**：8通道逻辑分析仪
🎓 **FPGA教学平台**：学习数字电路、通信协议、FPGA开发
🛠️ **原型验证**：快速验证通信协议和硬件设计

---

**项目作者**：Gemini及团队
**目标器件**：GOWIN GW5A-25A FPGA
**开发工具**：GOWIN EDA + ModelSim + Python
**协议规范**：详见 `doc/USB-CDC通信协议.md`
**代码组织**：模块化、可扩展、易维护

---

## 附录：参考资料

### A. 关键文件清单

| 类别 | 文件路径 | 说明 |
|------|---------|------|
| **顶层模块** | `rtl/top.v` | 顶层模块，连接所有子模块 |
| **协议解析** | `rtl/protocol_parser.v` | 帧解析器 |
| **指令处理** | `rtl/command_processor.v` | 指令分发器 |
| **USB接口** | `rtl/usb/usb_device_controller.v` | USB CDC控制器 |
| **UART** | `rtl/uart/uart.v` | UART收发器 |
| **I2C** | `rtl/i2c/` | I2C主从机 |
| **SPI** | `rtl/spi/spi_handler.v` | SPI主机 |
| **1-Wire** | `rtl/one_wire/one_wire_handler.v` | 1-Wire主机 |
| **PWM** | `rtl/pwm/pwm_handler.v` | 8通道PWM |
| **DAC/DDS** | `rtl/dds/DDS.v` | DDS信号生成器 |
| **DSM** | `rtl/digital_signal_measure.v` | 数字信号测量 |
| **DC** | `rtl/logic/digital_capture_handler.v` | 数字逻辑捕获 |
| **以太网** | `rtl/eth/eth_cmd.v` | 以太网命令处理 |
| **数据上传** | `rtl/upload_arbiter.v` | 上传仲裁器 |
| **约束文件** | `constraints/pin_cons.cst` | 引脚约束 |
| **协议文档** | `doc/USB-CDC通信协议.md` | 完整协议规范 |

### B. 联系方式

**项目地址**：（如有GitHub/Gitee请填写）
**问题反馈**：（如有Issue Tracker请填写）
**技术讨论**：（如有论坛/群组请填写）

---

**文档版本**：v1.0
**生成日期**：2025-10-31
**生成工具**：Claude Code
