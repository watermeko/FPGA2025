# 自定义序列发生器模块

## 概述

自定义序列发生器模块实现了8通道独立的数字序列输出功能。每个通道可配置：
- **基准频率**：每个比特位的输出频率
- **序列数据**：最多64位（8字节）的自定义比特模式
- **序列长度**：精确到位（1-64位）

序列会根据基准频率循环输出。

## 功能特性

- ✅ 8个独立通道
- ✅ 可配置基准频率（通过时钟分频）
- ✅ 1-64位可变长度序列
- ✅ 独立使能/禁用每个通道
- ✅ 循环输出模式
- ✅ 符合项目USB-CDC命令协议

## 模块文件

```
F:\FPGA2025\rtl\pwm/
├── seq_generator.v      - 单通道序列生成器核心
├── seq_multichannel.sv  - 8通道管理器
└── seq_handler.v        - 命令协议处理器

F:\FPGA2025\tb/
├── seq_generator_tb.v   - 核心模块测试台
└── seq_handler_tb.v     - 完整系统测试台

F:\FPGA2025\software/
└── seq_command_tool.py  - Python配置工具
```

## 工作原理示例

### 示例：1MHz基准频率，10位序列 "0101010101"

```
系统时钟: 60MHz
基准频率: 1MHz (每位持续1us)
序列: 0101010101 (10位)

输出:
  Bit 0 (0): 持续 1us
  Bit 1 (1): 持续 1us
  Bit 2 (0): 持续 1us
  ...
  Bit 9 (1): 持续 1us
  [循环回到 Bit 0]

完整序列周期: 10us
输出信号频率: 100kHz
```

**时序图**:
```
时间轴 (us):  0   1   2   3   4   5   6   7   8   9   10  11  12
序列输出:     0   1   0   1   0   1   0   1   0   1   0   1   0
              └─────────────一个周期─────────────┘
```

## 命令协议

### 命令码
`0xF0` - SEQ_CONFIG（序列配置）

### 命令格式

完整命令帧：
```
AA 55 | F0 | 00 0D | [13字节payload] | CS
```

**Payload结构（13字节）**:

| 字节索引 | 字段 | 说明 |
|---------|------|------|
| 0 | 通道索引 | bit[2:0]: 0-7 |
| 1 | 使能标志 | 0=禁用, 1=使能 |
| 2-3 | 频率分频器 | 16位，大端序 |
| 4 | 序列长度 | bit[6:0]: 1-64位 |
| 5-12 | 序列数据 | 8字节，小端序，LSB优先 |

### 配置计算

#### 频率分频器计算
```
freq_div = 系统时钟频率 / 基准频率

示例:
  系统时钟 = 60MHz
  基准频率 = 1MHz
  freq_div = 60,000,000 / 1,000,000 = 60
```

#### 输出频率计算
```
输出频率 = 基准频率 / 序列长度

示例:
  基准频率 = 1MHz
  序列长度 = 10位
  输出频率 = 1,000,000 / 10 = 100kHz
```

## 配置示例

### 示例1: 通道0，1MHz基准，10位交替模式

**需求**:
- 通道: 0
- 基准频率: 1MHz
- 序列: 0101010101 (10位)
- 预期输出: 100kHz方波

**计算**:
```python
freq_div = 60,000,000 / 1,000,000 = 60 (0x003C)
seq_len = 10 (0x0A)
seq_data = 0b0101010101 = 0x0155 (小端序: 55 01 00 00 00 00 00 00)
```

**命令包**:
```
AA 55 F0 00 0D 00 01 00 3C 0A 55 01 00 00 00 00 00 00 XX
│  │  │  │  │  │  │  │  │  │  └──────────┬──────────┘  │
│  │  │  │  │  │  │  │  │  │          序列数据         校验和
│  │  │  │  │  │  │  │  │  序列长度=10
│  │  │  │  │  │  │  │  频率分频器=60 (0x003C)
│  │  │  │  │  │  │  使能=1
│  │  │  │  │  │  通道=0
│  │  │  │  │  Payload长度=13
│  │  │  │  命令码=0xF0
│  │  │  头部
```

### 示例2: 通道1，2MHz基准，8位模式

**需求**:
- 通道: 1
- 基准频率: 2MHz
- 序列: 11001100 (8位)
- 预期输出: 250kHz

**计算**:
```
freq_div = 60,000,000 / 2,000,000 = 30 (0x001E)
seq_len = 8 (0x08)
seq_data = 0b11001100 = 0xCC
```

**命令包**:
```
AA 55 F0 00 0D 01 01 00 1E 08 CC 00 00 00 00 00 00 00 XX
```

### 示例3: 禁用通道0

```
AA 55 F0 00 0D 00 00 00 3C 0A 55 01 00 00 00 00 00 00 XX
                  ^^
                  使能=0
```

## 使用Python工具

### 安装
```bash
cd F:\FPGA2025\software
chmod +x seq_command_tool.py
```

### 基本用法

#### 1. 生成配置命令
```bash
python seq_command_tool.py --channel 0 --freq 1000000 --pattern "0101010101"
```

输出:
```
======================================================================
CUSTOM SEQUENCE GENERATOR COMMAND
======================================================================
Channel:            0
Enable:             True
System Clock:       60.0 MHz
Base Frequency:     1000.0 kHz (freq_div = 60)
Bit Pattern:        0101010101 (10 bits)
Output Frequency:   100.000 kHz
Sequence Period:    10.000 us

Command Packet (20 bytes):
AA 55 F0 00 0D 00 01 00 3C 0A 55 01 00 00 00 00 00 00 XX
...
```

#### 2. 保存到文件
```bash
python seq_command_tool.py -c 0 -f 1000000 -p "0101010101" -o cmd.bin
```

#### 3. 更多示例

**4位模式 @ 500kHz**:
```bash
python seq_command_tool.py -c 3 -f 500000 -p "1010"
```

**16位模式 @ 4MHz**:
```bash
python seq_command_tool.py -c 2 -f 4000000 -p "1010101011110000"
```

**禁用通道**:
```bash
python seq_command_tool.py -c 1 --disable
```

## 频率范围

基于60MHz系统时钟:

| 参数 | 最小值 | 最大值 | 备注 |
|------|--------|--------|------|
| 频率分频器 | 1 | 65535 | 16位 |
| 基准频率 | 915 Hz | 60 MHz | 受分频器限制 |
| 序列长度 | 1位 | 64位 | |
| 输出频率 | 14 Hz | 60 MHz | 基准频率/序列长度 |

### 常用频率示例

| 基准频率 | 分频器 | 10位序列输出频率 |
|---------|--------|-----------------|
| 10 MHz  | 6      | 1 MHz           |
| 5 MHz   | 12     | 500 kHz         |
| 2 MHz   | 30     | 200 kHz         |
| 1 MHz   | 60     | 100 kHz         |
| 500 kHz | 120    | 50 kHz          |
| 100 kHz | 600    | 10 kHz          |

## 集成到CDC控制器

在 `cdc.v` 中添加：

```verilog
// Sequence generator pins
wire [7:0] seq_pins;
wire       seq_cmd_ready;

// Instantiate sequence handler
seq_handler u_seq_handler (
    .clk(clk),
    .rst_n(rst_n),
    .cmd_type(cmd_type),
    .cmd_length(cmd_length),
    .cmd_data(cmd_data),
    .cmd_data_index(cmd_data_index),
    .cmd_start(cmd_start),
    .cmd_data_valid(cmd_data_valid),
    .cmd_done(cmd_done),
    .cmd_ready(seq_cmd_ready),
    .seq_pins(seq_pins)
);

// Add to cmd_ready OR logic
assign cmd_ready = ... || seq_cmd_ready;
```

在 `top.v` 中添加输出端口：
```verilog
output [7:0] seq_out,

// Connect to cdc module
assign seq_out = seq_pins;
```

## 引脚约束

在 `constraints/pin_cons.cst` 中添加：

```tcl
# Sequence generator outputs
IO_LOC "seq_out[0]" <PIN>;
IO_LOC "seq_out[1]" <PIN>;
IO_LOC "seq_out[2]" <PIN>;
IO_LOC "seq_out[3]" <PIN>;
IO_LOC "seq_out[4]" <PIN>;
IO_LOC "seq_out[5]" <PIN>;
IO_LOC "seq_out[6]" <PIN>;
IO_LOC "seq_out[7]" <PIN>;

IO_PORT "seq_out[0]" IO_TYPE=LVCMOS33;
IO_PORT "seq_out[1]" IO_TYPE=LVCMOS33;
# ... (repeat for all channels)
```

## 仿真运行

### ModelSim仿真

```bash
cd F:\FPGA2025\sim
mkdir seq_generator_tb

# 创建run_sim.do脚本
vlog ../rtl/pwm/seq_generator.v
vlog ../tb/seq_generator_tb.v
vsim -novopt seq_generator_tb
add wave -radix unsigned sim:/seq_generator_tb/*
run -all
```

或测试完整系统：
```bash
vlog ../rtl/pwm/seq_generator.v
vlog ../rtl/pwm/seq_multichannel.sv
vlog ../rtl/pwm/seq_handler.v
vlog ../tb/seq_handler_tb.v
vsim -novopt seq_handler_tb
add wave -radix binary sim:/seq_handler_tb/seq_pins
run -all
```

## 应用场景

1. **协议模拟**: 模拟SPI、I2C等串行协议的时钟/数据模式
2. **测试向量生成**: 产生重复测试序列用于被测设备
3. **时序发生器**: 生成特定时序的控制信号
4. **频率合成**: 通过序列长度调整产生分数分频
5. **PWM变体**: 产生非标准占空比的脉冲序列

## 故障排除

### 输出频率不正确
- 检查 `freq_div` 计算是否正确
- 确认系统时钟频率（默认60MHz）
- 验证序列长度设置

### 序列模式错误
- 序列数据为**小端序**，LSB对应第一位输出
- 检查位模式字符串中只包含'0'和'1'
- 确认序列长度与实际位数匹配

### 通道无输出
- 检查使能位是否设置为1
- 确认 `freq_div` 不为0
- 验证 `seq_len` 大于0

## 技术规格

- **FPGA平台**: GOWIN GW5A-25A
- **系统时钟**: 60MHz (PHY_CLK)
- **通道数**: 8
- **序列长度**: 1-64位
- **时钟分频器**: 16位 (1-65535)
- **资源占用** (预估):
  - LUT: ~200 per channel
  - FF: ~100 per channel
  - BRAM: 0

## 版本历史

- **v1.0** (2025-10-24): 初始版本
  - 8通道独立序列发生器
  - 可配置基准频率和序列
  - USB-CDC命令协议支持
  - Python配置工具

## 许可证

与FPGA2025项目相同

---

**作者**: Claude
**日期**: 2025-10-24
**项目**: FPGA2025 自定义序列发生器
