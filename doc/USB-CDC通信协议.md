# USB-CDC通信协议

| 字段     | 字节数 |
| -------- | ------ |
| 帧头     | 2      |
| 功能码/数据来源   | 1      |
| 数据长度 | 2      |
| 数据体   | 0-65535 |
|校验和|1|


## 帧头

指令为0xAA55。上传的数据为0xAA44。

## 功能码

| 功能码 | 功能描述 | 完成情况|
| ------ | -------- | |
| 0x01   | **配置SPI** | 未实现 |
| 0x02   | **发送SPI数据** | 未实现 |
| 0x03   | **接收SPI数据** | 未实现 |
| 0x04   | **配置I2C** | 未实现 |
| 0x05   | **发送I2C数据** | 未实现 |
| 0x06   | **接收I2C数据** | 未实现 |
| 0x07   | **配置UART** |✅|
| 0x08   | **发送UART数据** |✅|
| 0x09   | **接收UART数据** | ✅ |
| 0x0A   | **数字信号测量** |✅|
| 0x11   | **SPI读写操作** |✅|
| 0xFD   | **配置DAC输出**|✅|
| 0xFE   | **配置PWM输出** |✅|
|0xFF|**心跳测试**|✅|

## 数据长度

- **值**: 16位无符号整数，例如 `0x000A` 表示数据体有10个字节。
- **字节序**: 大端模式（Big-Endian）**，即高字节在前。`0x000A` 发送时就是 `0x00` 先发，`0x0A` 后发。

## 数据体

### SPI读写操作 (功能码 0x11)
| 字段 | 字节数 | 说明 |
|------|--------|------|
| 写长度 | 1 | 要发送的数据字节数 (0-255) |
| 读长度 | 1 | 要读取的数据字节数 (0-255) |
| 发送数据 | write_len | 要发送的数据字节 |

**操作说明**：
- 该功能支持同时进行写和读操作
- 先发送write_len个字节的数据到SPI从机
- 然后从SPI从机读取read_len个字节的数据
- 如果write_len=0且read_len>0，只进行读取操作
- 如果read_len=0，只进行写入操作，不上传接收数据

**响应数据格式**：
- 帧头：0xAA44（上传数据标识）
- 数据来源：0x03（SPI模块）
- 数据长度：read_len
- 数据体：实际读取到的read_len个字节数据

**示例1**：写2字节，读1字节
```
发送: AA 55 11 00 04 02 01 AB CD 90
      ^^^^帧头 ^^功能码 ^^^^长度 ^^写2字节 ^^读1字节 ^^^^发送数据 ^^校验和
响应: AA 44 03 00 01 EF yy (yy为校验和)
      ^^^^上传帧头 ^^SPI源 ^^^^长度1 ^^读取的数据
```

**示例2**：只读2字节
```
发送: AA 55 11 00 02 00 02 15
      ^^^^帧头 ^^功能码 ^^^^长度 ^^写0字节 ^^读2字节 ^^校验和
响应: AA 44 03 00 02 12 34 yy (yy为校验和)
```

**示例3**：只写1字节（不读取）
```
发送: AA 55 11 00 03 01 00 AB C0
      ^^^^帧头 ^^功能码 ^^^^长度 ^^写1字节 ^^读0字节 ^^发送数据 ^^校验和
响应: 无（read_len=0，不上传数据）
```

**示例4**：写1字节，读1字节（回环测试）
```
发送: AA 55 11 00 03 01 01 AB C1
      ^^^^帧头 ^^功能码 ^^^^长度 ^^写1字节 ^^读1字节 ^^发送数据 ^^校验和
响应: AA 44 03 00 01 AB yy (如果MOSI-MISO短接，返回相同数据)
```

### SPI配置 (功能码 0x01) - 未实现
保留供未来扩展

### SPI发送 (功能码 0x02) - 未实现
保留供未来扩展

### SPI接收 (功能码 0x03) - 未实现
保留供未来扩展

### I2C配置 (功能码 0x04)
字段	      描述	                        值 (Hex)	      备注
数据长度	1个字节的数据体	             00 01	      大端模式
数据体	7位从机地址	                   40	           您指定的地址 0x40
校验和	(AA+55+04+00+01+40)&0xFF      44	           0x144 的低8位
AA 55 04 00 01 50 55

### I2C发送 (功能码 0x05)
字段	      描述	                             值 (Hex)	      备注
数据长度	3个字节的数据体	                  00 03	            2字节地址 + 1字节数据
数据体	寄存器地址高位	                  01	            假设的内部地址 0x0100
数据体	寄存器地址低位	                  00	
数据体	要写入的数据	                  FF	            您指定的目标数据
校验和	(AA+55+05+00+03+01+00+FF) & 0xFF   A7	            0x2A7 的低8位
AA 55 05 00 06 00 3C DE AD BE EF 7F

### I2C接收 (功能码 0x06)
字段	      描述	                                   值 (Hex)	      备注
数据长度	4个字节的数据体	                        00 04	            2字节地址 + 2字节读取长度
数据体	寄存器地址高位	                        01	            从地址 0x0100 开始读
数据体	寄存器地址低位	                        00	
数据体	要读取的长度高位	                        00	            我们只想读取1个字节
数据体	要读取的长度低位	                        01	
校验和	(AA+55+06+00+04+01+00+00+01) & 0xFF	      B1	                  0x1B1 的低8位
AA 55 06 00 04 00 3C 00 04 4A

上述指令可以成功实现eeprom读写
改 i2c_handler 的 device_addr_reg 就行，每个I2C 器件都有自己的器件地址
未来打算在i2c配置中增设 i2c 地址传输 这个简单一点

### UART配置 (功能码 0x07) 
| 字段 | 字节数 | 说明 |
|------|--------|------|
| 波特率 | 4 | 32位整数，如9600, 115200等 |
| 数据位 | 1 | 5, 6, 7, 8 |
| 停止位 | 1 | 1, 1.5, 2 |
| 校验位 | 1 | 0: 无校验, 1: 奇校验, 2: 偶校验 |

### UART发送 (功能码 0x08)
数据体为要发送的原始数据字节

### UART接收 (功能码 0x09)
数据体为空，响应为接收到的数据字节

### 数字信号测量 (功能码 0x0A)
| 字段 | 字节数 | 说明 |
|------|--------|------|
| 通道掩码 | 1 | 8位掩码，每位对应一个测量通道，1表示启用该通道测量 |

**响应数据格式** (每个启用的通道返回9字节数据)：
| 字段 | 字节数 | 说明 |
|------|--------|------|
| 通道号 | 1 | 当前数据对应的通道号 (0-7) |
| 高电平时间 | 2 | 16位无符号整数，单位：时钟周期 |  
| 低电平时间 | 2 | 16位无符号整数，单位：时钟周期 |
| 周期时间 | 2 | 16位无符号整数，单位：时钟周期 |
| 占空比 | 2 | 16位无符号整数，单位：百分比×100 |

**示例**：
- 启用通道0和2：通道掩码 = 0x05 (二进制: 00000101)
- 返回数据：通道0的9字节数据 + 通道2的9字节数据，共18字节

### DAC配置 (功能码 0xFD)
| 字段 | 字节数 | 说明 |
|------|--------|------|
| 波形类型 | 1 | 0: 正弦波, 1: 三角波, 2: 锯齿波, 3: 方波 |
| 频率字 | 4 | 32位整数，DDS频率控制字，大端模式 |
| 相位字 | 4 | 32位整数，DDS相位控制字，大端模式 |

**频率字计算公式**：
fre_word = (目标频率 × 2^32) / DAC时钟频率

**示例**：
- DAC时钟频率：200MHz
- 生成1MHz信号：fre_word = (1MHz × 2^32) / 200MHz = 21474836

**相位字计算公式**：
pha_word = (目标相位角度 × 2^32) / 360°

**示例**：
- 90度相位：pha_word = (90° × 2^32) / 360° = 1073741824

### PWM配置 (功能码 0xFE)
| 字段 | 字节数 | 说明 |
|------|--------|------|
| 通道号 | 1 | PWM输出通道编号 |
| 周期 | 2 | 32位整数，单位ns |
| 占空比 | 2 | 32位整数，单位ns |

### 心跳测试 (功能码 0xFF)
数据体为空，响应数据体也为空

## 校验和 （？）

从帧头开始到数据体结束的所有字节的累加和，取低8位。

// 校验和的累加实际上是从功能码（CMD）字节开始的，不包含 0xAA 和 0x55
