# USB-CDC通信协议

| 字段     | 字节数 |
| -------- | ------ |
| 帧头     | 2      |
| 功能码/数据来源   | 1      |
| 数据长度 | 2      |
| 数据体   | 0-65535 |
|校验和|1|


## 帧头

指令为0xAA55。上传的数据为0xAA44。

## 功能码

| 功能码 | 功能描述 | 完成情况|
| ------ | -------- | |
| 0x01   | **配置SPI** | ✅ |
| 0x02   | **发送SPI数据** | ✅ |
| 0x03   | **接收SPI数据** | ✅ |
| 0x04   | **配置I2C** | ✅ |
| 0x05   | **发送I2C数据** | ✅ |
| 0x06   | **接收I2C数据** | ✅ |
| 0x07   | **配置UART** |✅|
| 0x08   | **发送UART数据** |✅|
| 0x09   | **接收UART数据** | ✅ |
| 0x0A   | **数字信号测量** |✅|
| 0x0B   | **数字逻辑捕获启动** |✅|
| 0x0C   | **数字逻辑捕获停止** |✅|
| 0x11   | **SPI读写操作** |✅|
| 0x20   | **1-Wire复位** |✅|
| 0x21   | **1-Wire写字节** |✅|
| 0x22   | **1-Wire读字节** |✅|
| 0x23   | **1-Wire写读操作** |✅|
| 0xFC   | **自定义波形上传** |✅|
| 0xFD   | **配置DAC输出**|✅|
| 0xFE   | **配置PWM输出** |✅|
| 0xFF   | **心跳测试**|✅|

## 数据长度

- **值**: 16位无符号整数，例如 `0x000A` 表示数据体有10个字节。
- **字节序**: 大端模式（Big-Endian）**，即高字节在前。`0x000A` 发送时就是 `0x00` 先发，`0x0A` 后发。

## 数据体

### SPI读写操作 (功能码 0x11)
| 字段 | 字节数 | 说明 |
|------|--------|------|
| 写长度 | 1 | 要发送的数据字节数 (0-255) |
| 读长度 | 1 | 要读取的数据字节数 (0-255) |
| 发送数据 | write_len | 要发送的数据字节 |

**操作说明**：
- 该功能支持同时进行写和读操作
- 先发送write_len个字节的数据到SPI从机
- 然后从SPI从机读取read_len个字节的数据
- 如果write_len=0且read_len>0，只进行读取操作
- 如果read_len=0，只进行写入操作，不上传接收数据

**响应数据格式**：
- 帧头：0xAA44（上传数据标识）
- 数据来源：0x03（SPI模块）
- 数据长度：read_len
- 数据体：实际读取到的read_len个字节数据

**示例1**：写2字节，读1字节
```
发送: AA 55 11 00 04 02 01 AB CD 90
      ^^^^帧头 ^^功能码 ^^^^长度 ^^写2字节 ^^读1字节 ^^^^发送数据 ^^校验和
响应: AA 44 03 00 01 EF yy (yy为校验和)
      ^^^^上传帧头 ^^SPI源 ^^^^长度1 ^^读取的数据
```

**示例2**：只读2字节
```
发送: AA 55 11 00 02 00 02 15
      ^^^^帧头 ^^功能码 ^^^^长度 ^^写0字节 ^^读2字节 ^^校验和
响应: AA 44 03 00 02 12 34 yy (yy为校验和)
```

**示例3**：只写1字节（不读取）
```
发送: AA 55 11 00 03 01 00 AB C0
      ^^^^帧头 ^^功能码 ^^^^长度 ^^写1字节 ^^读0字节 ^^发送数据 ^^校验和
响应: 无（read_len=0，不上传数据）
```

**示例4**：写1字节，读1字节（回环测试）
```
发送: AA 55 11 00 03 01 01 AB C1
      ^^^^帧头 ^^功能码 ^^^^长度 ^^写1字节 ^^读1字节 ^^发送数据 ^^校验和
响应: AA 44 03 00 01 AB yy (如果MOSI-MISO短接，返回相同数据)
```

### SPI配置 (功能码 0x01) - 未实现
保留供未来扩展

### SPI发送 (功能码 0x02) - 未实现
保留供未来扩展

### SPI接收 (功能码 0x03) - 未实现
保留供未来扩展

### I2C配置 (功能码 0x04)
| 字段         | 描述                    | 值 (Hex)                | 备注                                               |
| ------------ | ----------------------- | ----------------------- | -------------------------------------------------- |
| 帧头         | 固定的指令帧头          | AA 55                   |                                                    |
| 功能码       | I2C配置                 | 0x04                    |                                                    |
| 数据长度     | 2个字节的数据体         | 00 02                   |                                                    |
| 数据体       | 7位从机地址             | 50                      | 目标设备地址                                       |
| 数据体       | 时钟频率代码            | 03                      | 0x03 代表 400kHz（0代表50k，1代表100k，2代表200k） |
| 校验和       | (04+00+02+50+03) & 0xFF | 59                      |                                                    |
| **完整指令** |                         | AA 55 04 00 02 40 01 47 |                                                    |

### I2C发送 (功能码 0x05)

| 字段         | 描述                                | 值 (Hex)                            | 备注                  |
| ------------ | ----------------------------------- | ----------------------------------- | --------------------- |
| 帧头         | 固定的指令帧头                      | AA 55                               |                       |
| 功能码       | I2C发送                             | 0x05                                |                       |
| 数据长度     | 6个字节的数据体                     | 00 06                               | 2字节地址 + 4字节数据 |
| 数据体[1:0]  | 寄存器地址                          | 00 3C                               |                       |
| 数据体[5:2]  | 要写入的数据                        | DE AD BE EF                         |                       |
| 校验和       | (05+00+06+00+3C+DE+AD+BE+EF) & 0xFF | 7F                                  |                       |
| **完整指令** |                                     | AA 55 05 00 06 00 3C DE AD BE EF 7F |                       |

### I2C接收 (功能码 0x06)
|              |                               |                               |                       |
| ------------ | ----------------------------- | ----------------------------- | --------------------- |
| 字段         | 描述                          | 值 (Hex)                      | 备注                  |
| 帧头         | 固定的指令帧头                | AA 55                         |                       |
| 功能码       | I2C接收                       | 0x06                          |                       |
| 数据长度     | 4个字节的数据体               | 00 04                         | 2字节地址 + 2字节长度 |
| 数据体[1:0]  | 寄存器地址                    | 00 3C                         |                       |
| 数据体[3:2]  | 要读取的长度                  | 00 04                         | 读取4个字节           |
| 校验和       | (06+00+04+00+3C+00+04) & 0xFF | 4A                            |                       |
| **完整指令** |                               | AA 55 06 00 04 00 3C 00 04 4A |                       |


 待办：

实现控制无寄存器从机

### UART配置 (功能码 0x07) 
| 字段 | 字节数 | 说明 |
|------|--------|------|
| 波特率 | 4 | 32位整数，如9600, 115200等 |
| 数据位 | 1 | 5, 6, 7, 8 |
| 停止位 | 1 | 1, 1.5, 2 |
| 校验位 | 1 | 0: 无校验, 1: 奇校验, 2: 偶校验 |

### UART发送 (功能码 0x08)
数据体为要发送的原始数据字节

### UART接收 (功能码 0x09)
数据体为空，响应为接收到的数据字节

### 数字信号测量 (功能码 0x0A)
| 字段 | 字节数 | 说明 |
|------|--------|------|
| 通道掩码 | 1 | 8位掩码，每位对应一个测量通道，1表示启用该通道测量 |

**响应数据格式** (每个启用的通道返回9字节数据)：
| 字段 | 字节数 | 说明 |
|------|--------|------|
| 通道号 | 1 | 当前数据对应的通道号 (0-7) |
| 高电平时间 | 2 | 16位无符号整数，单位：时钟周期 |  
| 低电平时间 | 2 | 16位无符号整数，单位：时钟周期 |
| 周期时间 | 2 | 16位无符号整数，单位：时钟周期 |
| 占空比 | 2 | 16位无符号整数，单位：百分比×100 |

**示例**：
- 启用通道0和2：通道掩码 = 0x05 (二进制: 00000101)
- 返回数据：通道0的9字节数据 + 通道2的9字节数据，共18字节

### 数字逻辑捕获启动 (功能码 0x0B)
| 字段 | 字节数 | 说明 |
|------|--------|------|
| 采样分频高字节 | 1 | 分频系数高8位 |
| 采样分频低字节 | 1 | 分频系数低8位 |

**功能说明**：
- 启动 8 通道数字逻辑实时捕获
- 采样率 = 系统时钟频率 / 分频系数 (60MHz / divider)
- 捕获后的数据通过 USB 连续流式上传（直通模式，无协议封装）
- 每个采样周期产生 1 字节数据（8 通道状态）

**分频系数计算**：
```
divider = 60,000,000 / 目标采样率

示例：
- 1 MHz 采样: divider = 60
- 500 kHz 采样: divider = 120
- 100 kHz 采样: divider = 600
```

**数据格式**：
- 每字节对应一个采样时刻
- Bit[7:0] = [CH7, CH6, CH5, CH4, CH3, CH2, CH1, CH0]
- 1 = 高电平，0 = 低电平

**上传数据格式（直通模式）**：
- **无协议头**，直接输出原始采样字节流
- PC 端需要特殊处理，识别数据来源为 Digital Capture
- 数据源标识：0x0B（仅在系统内部使用）

**示例**：
```
发送: AA 55 0B 00 02 00 3C 9F
      ^^^^帧头 ^^功能码 ^^^^长度=2 ^^分频高 ^^分频低 ^^校验和

      divider = 0x003C = 60 → 1MHz 采样率

响应: 连续字节流（无帧头）
      AA 55 AA 55 FF 00 ...
      ^^  ^^  ^^  ^^  ^^  ^^
    采样1 2   3   4   5   6
```

**限制**：
- 最大采样率：1.2 MHz (divider = 50)
- 推荐采样率：≤ 1 MHz (稳定运行)
- 最小分频系数：50
- 最大分频系数：65535

**注意事项**：
- ⚠️ 启动采集后，USB 带宽将被占用
- ⚠️ 必须发送 STOP 命令 (0x0C) 才能停止采集
- ⚠️ 采集期间其他模块的数据上传可能受影响

### 数字逻辑捕获停止 (功能码 0x0C)
| 字段 | 字节数 | 说明 |
|------|--------|------|
| 数据体 | 0 | 无数据 |

**功能说明**：
- 停止正在进行的数字逻辑捕获
- 释放 USB 带宽
- 允许其他模块正常上传数据

**示例**：
```
发送: AA 55 0C 00 00 12
      ^^^^帧头 ^^功能码 ^^^^长度=0 ^^校验和
响应: 无（采集停止，数据流中断）
```

**完整采集流程示例**：
```
1. 启动 1MHz 采样:
   AA 55 0B 00 02 00 3C 9F

2. 接收连续数据流 (无协议头):
   AA 55 FF 00 AA 55 ... (持续接收)

3. 停止采集:
   AA 55 0C 00 00 12

4. 数据流停止
```

### 自定义波形上传 (功能码 0xFC)

该功能允许用户上传任意波形数据到FPGA内部RAM，突破预定义波形限制，实现真正的任意波形输出。**支持双通道独立波形配置**。

#### 数据格式

| 字段 | 字节数 | 说明 |
|------|--------|------|
| 控制字 | 1 | 操作模式、配置标志和通道选择 |
| 波形长度 | 2 | 波形采样点数 (1-4096)，大端模式 |
| 采样率字 | 4 | DDS频率控制字，控制播放速率，大端模式 |
| 波形数据 | N×2 | 每个采样点14位，按2字节打包 (高2位填0) |

#### 控制字定义 (Bit[7:0])

| 位域 | 说明 |
|------|------|
| Bit[1:0] | 操作模式：<br>`00` = 写入新波形（清除旧数据）<br>`01` = 追加波形数据（分包传输）<br>`10` = 启动播放<br>`11` = 停止播放 |
| Bit[2] | 循环模式：`0` = 单次播放，`1` = 循环播放 |
| Bit[3] | 通道选择：`0` = 通道A，`1` = 通道B |
| Bit[7:4] | 保留，填0 |

#### 波形数据编码

每个采样点为14位DAC数据，范围 `0x0000 - 0x3FFF`：
- `0x0000`: 最小输出电压
- `0x2000`: 中间电压（零点偏移）
- `0x3FFF`: 最大输出电压

每个采样点打包为2字节（小端模式）：
```
采样点值: 0x2A5C (14位有效)
字节[0] = 0x5C (低字节)
字节[1] = 0x2A (高字节，仅低6位有效)
```

#### 采样率字计算

采样率字控制波形播放速度，使用与DAC配置相同的DDS频率字：

```
sample_rate_word = round((波形播放频率 × 2^20) / DAC时钟频率)
```

**示例**：
- DAC时钟：120MHz
- 波形长度：256点
- 期望输出频率：1kHz
- 波形播放频率 = 1kHz × 256点 = 256kHz
- sample_rate_word = round((256kHz × 2^20) / 120MHz) = 2241
- 最终发送时至少取1以避免静止输出

#### 分包传输策略

单个USB-CDC帧最大65535字节，256点波形只需512字节数据，通常可一次发送：

**单包发送** (控制字[1:0] = `00`):
```
控制字 | 波形长度 | 采样率字 | 256个采样点
  1B   |   2B     |   4B     |  512B
```

**启动播放** (控制字[1:0] = `10`):
```
控制字 | 0x0000 | 0x00000000
  1B   |   2B   |     4B
```
最小7字节命令，仅包含头部，无波形数据

#### 使用示例

**示例1：一次性上传波形（128点）**
```
发送: AA 55 FC 01 03 04 00 80 00 08 C1 00 [256字节波形数据...] XX
      ^^^^帧头 ^^功能码 ^^^^长度(259) ^^控制字(写入+循环) ^^^^波形长度(128) ^^^^^^^^采样率字 ^^^^^^波形数据 ^^校验和

控制字=0x04: Bit[2]=1(循环), Bit[1:0]=00(写入新波形)
```

**示例2：上传256点波形并循环播放**

上传波形（256点）：
```
发送: AA 55 FC 02 03 00 01 00 00 08 C1 00 [512字节波形数据...] XX
      ^^^^帧头 ^^功能码 ^^^^长度(519) ^^控制字(写入) ^^^^波形长度(256) ^^^^^^^^采样率字 ^^^^^^256点 ^^校验和

控制字=0x00: Bit[1:0]=00(写入新波形)
```

启动循环播放：
```
发送: AA 55 FC 00 07 06 00 00 00 00 00 00 XX
      ^^^^帧头 ^^功能码 ^^^^长度(7) ^^控制字(启动+循环) ^^^^填0 ^^^^^^^^填0 ^^校验和

控制字=0x06: Bit[2]=1(循环), Bit[1:0]=10(启动播放)
```

**示例3：停止播放**
```
发送: AA 55 FC 00 07 03 00 00 00 00 00 00 XX
      ^^^^帧头 ^^功能码 ^^^^长度(7) ^^控制字(停止) ^^^^填0 ^^^^^^^^填0 ^^校验和

控制字=0x03: Bit[1:0]=11(停止播放)
```

#### 使用流程

1. **上传波形**: 发送控制字=`0x00`或`0x04`的单包（256点以内无需分包）
2. **启动播放**: 发送控制字=`0x02`（单次）或`0x06`（循环）
3. **修改波形**: 重复步骤1（会覆盖旧波形）
4. **停止播放**: 发送控制字=`0x03`

#### 响应

成功接收返回状态帧（可选实现）：
```
响应: AA 44 FC 00 02 状态码 错误码 XX
      ^^^^上传帧头 ^^自定义波形源 ^^^^长度 ^^^^^^状态 ^^错误 ^^校验和

状态码: 0x00=成功, 0x01=接收中, 0xFF=错误
错误码: 0x00=无错误, 0x01=长度错误, 0x02=地址溢出
```

#### 限制

- 最大波形长度: 256个采样点（512字节）
- 采样点精度: 14位 (0-16383)
- 建议分包大小: ≤512字节/包
- DAC时钟频率: 120MHz (固定)

### DAC配置 (功能码 0xFD)

**支持双通道独立配置**。每个通道可配置不同的波形类型、频率和相位。

| 字段 | 字节数 | 说明 |
|------|--------|------|
| 通道号 | 1 | 0: 通道A, 1: 通道B |
| 波形类型 | 1 | 0: 正弦波, 1: 三角波, 2: 锯齿波, 3: 方波, 4: 梯形波 |
| 频率字 | 4 | 32位整数，DDS频率控制字，大端模式 |
| 相位字 | 4 | 32位整数，DDS相位控制字，大端模式 |

**频率字计算公式**：
fre_word = (目标频率 × 2^32) / DAC时钟频率

**示例**：
- DAC时钟频率：200MHz
- 生成1MHz信号：fre_word = (1MHz × 2^32) / 200MHz = 21474836

**相位字计算公式**：
pha_word = (目标相位角度 × 2^32) / 360°

**示例**：
- 90度相位：pha_word = (90° × 2^32) / 360° = 1073741824

### PWM配置 (功能码 0xFE)
| 字段 | 字节数 | 说明 |
|------|--------|------|
| 通道号 | 1 | PWM输出通道编号 |
| 周期 | 2 | 32位整数，单位ns |
| 占空比 | 2 | 32位整数，单位ns |

### 1-Wire 复位 (功能码 0x20)
| 字段 | 字节数 | 说明 |
|------|--------|------|
| 数据体 | 0 | 无数据 |

**功能说明**：
- 执行 1-Wire 总线复位序列
- 检测从机应答脉冲
- 用于每次通信前初始化总线或检测从机在线状态

**示例**：
```
发送: AA 55 20 00 00 1F
      ^^^^帧头 ^^功能码 ^^^^长度=0 ^^校验和
响应: 无
```

### 1-Wire 写字节 (功能码 0x21)

| 字段 | 字节数 | 说明 |
|------|--------|------|
| 写数据 | N | 要发送的数据字节 (1-255) |

**功能说明**：
- 向 1-Wire 总线写入一个或多个字节
- LSB first（最低位先发）
- 用于发送 ROM 命令或功能命令

**示例**：写 Skip ROM 命令 (0xCC)
```
发送: AA 55 21 00 01 CC 31
      ^^^^帧头 ^^功能码 ^^^^长度=1 ^^数据 ^^校验和
响应: 无
```

### 1-Wire 读字节 (功能码 0x22)
| 字段 | 字节数 | 说明 |
|------|--------|------|
| 数据体 | 0 | 数据长度字段指定读取字节数 |

**功能说明**：
- 从 1-Wire 总线读取指定数量的字节
- LSB first（最低位先读）

**响应数据格式**：
- 帧头：0xAA44（上传数据标识）
- 数据来源：0x04（1-Wire 模块）
- 数据长度：读取的字节数
- 数据体：实际读取到的数据

**示例**：读取 8 字节 ROM ID
```
发送: AA 55 22 00 08 2B
      ^^^^帧头 ^^功能码 ^^^^长度=8 ^^校验和
响应: AA 44 04 00 08 [8字节ROM ID] YY
      ^^^^上传帧头 ^^1-Wire源 ^^^^长度=8 ^^^ROM ID^^^ ^^校验和
```

### 1-Wire 写读操作 (功能码 0x23)
| 字段 | 字节数 | 说明 |
|------|--------|------|
| 写长度 | 1 | 要发送的字节数 (0-255) |
| 读长度 | 1 | 要读取的字节数 (0-255) |
| 写数据 | write_len | 要发送的数据 |

**功能说明**：
- 先写入命令/地址，然后读取响应数据
- 最常用的操作模式

**响应数据格式**：
- 帧头：0xAA44
- 数据来源：0x04
- 数据长度：read_len
- 数据体：读取的数据

**示例 1**：DS18B20 读温度（写 1 字节，读 9 字节）

```
发送: AA 55 23 00 03 01 09 BE 37
      ^^^^帧头 ^^功能码 ^^^^长度=3 ^^写1 ^^读9 ^^Read Scratchpad ^^校验和
响应: AA 44 04 00 09 [9字节暂存器数据] YY
      ^^^^上传帧头 ^^1-Wire源 ^^^^长度=9 ^^^暂存器内容^^^ ^^校验和
```

**示例 2**：读取 ROM ID（写 1 字节，读 8 字节）
```
发送: AA 55 23 00 03 01 08 33 6C
      ^^^^帧头 ^^功能码 ^^^^长度=3 ^^写1 ^^读8 ^^Read ROM ^^校验和
响应: AA 44 04 00 08 [8字节ROM ID] YY
      ^^^^上传帧头 ^^1-Wire源 ^^^^长度=8 ^^^ROM ID^^^ ^^校验和
```

**DS18B20 完整读温度流程**：
```
1. 复位: AA 55 20 00 00 1F
2. Skip ROM: AA 55 21 00 01 CC 31
3. Convert T: AA 55 21 00 01 44 65
4. 等待 750ms (温度转换时间)
5. 复位: AA 55 20 00 00 1F
6. Skip ROM: AA 55 21 00 01 CC 31
7. 读暂存器: AA 55 23 00 03 01 09 BE 37
8. 解析温度: T = (T_MSB << 8 | T_LSB) / 16.0 °C
```

### 心跳测试 (功能码 0xFF)
数据体为空，响应数据体也为空

## 数据来源标识 (上传数据)

| 数据来源 | 标识 | 说明 |
|---------|------|------|
| UART | 0x01 | 外部 UART 接收数据 |
| SPI | 0x03 | SPI 读取数据 |
| 1-Wire | 0x04 | 1-Wire 读取数据 |
| DSM | 0x0A | 数字信号测量数据 |
| Digital Capture | 0x0B | 数字逻辑捕获（直通模式，无协议头）|

**注意**：
- Digital Capture (0x0B) 采用**直通上传模式**，数据流中**无协议头**
- 其他模块采用标准协议格式：`0xAA44 + source + length + data + checksum`

## 校验和

从帧头开始到数据体结束的所有字节的累加和，取低8位。

// 校验和的累加实际上是从功能码（CMD）字节开始的，不包含 0xAA 和 0x55
