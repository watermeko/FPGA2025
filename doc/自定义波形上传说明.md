# 自定义波形上传说明

## 模块概述
- `rtl/dds/custom_waveform_handler.sv` 负责解析 0xFC 命令, 完成单包波形写入并根据控制字决定是否循环播放。
- 波形数据存放在 4096×14bit RAM 中, 上传完成后立即开始播放; 当控制字 Bit2 = 1 时启用循环。

## 数据帧结构
| 字段 | 字节数 | 说明 |
| --- | --- | --- |
| 帧头 | 2 | 固定 `0xAA 0x55` |
| 功能码 | 1 | 固定 `0xFC` |
| 长度 | 2 | `0x0007 + 采样点数 × 2` |
| 控制字 | 1 | Bit2 = 1 表示循环播放, 其余位保留 |
| 波形长度 | 2 | 采样点数 (大端) |
| 采样率字 | 4 | DDS 频率字 (大端) |
| 波形数据 | N×2 | 每个采样点 14bit, 小端存储 |
| 校验和 | 1 | 从功能码开始的累加和低 8bit |

## 集成要点
- `cmd_ready` 应与系统内其他模块共享用于仲裁命令通道。
- 上传命令开始时模块会拉低 `play_enable`, 处理完成后自动启动播放。
- `dac_clk` 域通过同步逻辑获得 `loop_enable`、`sample_rate_word` 和 `waveform_length`, 无需额外握手。

## PC 端工具
- `software/custom_waveform_tool.py` 生成并发送单包数据(导出的 CSV 为单列 14bit 整数, 可直接用于仿真)。GUI 依赖 PySide6, 可直接运行 `python software/custom_waveform_tool.py --gui --port COM3`。
- 示例:
  ```bash
  python software/custom_waveform_tool.py --file waveform.csv --port COM3 --freq 1000 --sample-rate 512000 --loop
  ```
- `--freq` 指定期望波形频率, `--sample-rate` 可显式设置播放采样率(缺省为 `freq × 采样点数`), `--loop` 控制循环播放。
- GUI 模式提供频率/采样率输入框与导出文件路径选项, 便于实时调节后上传或生成 CSV。

## 测试建议
- 仿真: 分别验证循环与非循环单包上传, 检查 RAM 写入与 DDS 地址循环行为。
- 硬件: 上传已知波形并使用示波器确认输出频率与幅值, 检查循环播放是否持续稳定。
