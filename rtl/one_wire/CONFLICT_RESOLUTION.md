# 功能码冲突解决方案

## 🔴 问题发现

用户发现 1-Wire 的功能码 **0x11** 与 SPI 模块发生冲突！

### 冲突详情

| 功能码 | 原 1-Wire 定义 | SPI Handler | 冲突状态 |
|--------|--------------|-------------|---------|
| **0x11** | `CMD_ONEWIRE_WRITE` | `CMD_SPI_WRITE` | ❌ **冲突** |

**影响**：
- 当 `command_processor` 接收到 `0x11` 时，两个 handler 都会响应
- 造成总线冲突和不可预测行为
- 功能无法正常工作

---

## ✅ 解决方案

用户建议：**从 0x20 开始分配 1-Wire 功能码**

### 新的功能码分配

| 功能 | 原功能码 | 新功能码 | 描述 |
|------|---------|---------|------|
| 1-Wire 复位 | 0x10 | **0x20** | Reset and detect presence |
| 1-Wire 写字节 | 0x11 | **0x21** | Write bytes to 1-Wire bus |
| 1-Wire 读字节 | 0x12 | **0x22** | Read bytes from 1-Wire bus |
| 1-Wire 写读操作 | 0x13 | **0x23** | Write then read |

### 优点

✅ **完全避开冲突** - 0x20-0x23 与现有功能码无重叠
✅ **连续编号** - 逻辑清晰，易于记忆
✅ **预留空间** - 0x24-0x2F 可用于未来 1-Wire 扩展
✅ **无需修改 SPI** - SPI 模块保持不变

---

## 📋 已完成的修改

### 1. 核心代码
✅ `one_wire_handler.v` - 更新功能码定义
```verilog
localparam CMD_ONEWIRE_RESET       = 8'h20;  // 0x10 → 0x20
localparam CMD_ONEWIRE_WRITE       = 8'h21;  // 0x11 → 0x21
localparam CMD_ONEWIRE_READ        = 8'h22;  // 0x12 → 0x22
localparam CMD_ONEWIRE_WRITE_READ  = 8'h23;  // 0x13 → 0x23
```

### 2. 协议文档
✅ `USB-CDC通信协议.md` - 更新功能码表和所有示例
- 功能码表：0x10/0x12/0x13 → 0x20/0x22/0x23
- 所有命令示例的功能码和校验和
- DS18B20 完整操作流程

### 3. 详细协议说明
✅ `PROTOCOL.md` - 更新所有功能码说明
- 4个功能码的详细说明
- 所有命令示例
- DS18B20 操作流程
- Python 测试代码示例

### 4. 测试脚本
✅ `one_wire_test.py` - 更新所有测试命令
- test_reset(): 0x10 → 0x20
- test_read_rom(): 0x13 → 0x23
- test_read_temperature(): 0x10/0x14 → 0x20/0x21, 0x13 → 0x23

### 5. 快速参考
✅ `QUICK_REFERENCE.md` - 更新命令速查
- 功能码速查表
- DS18B20 完整流程
- Python 代码片段

### 6. 项目总结
✅ `README.md` - 更新项目说明
- 支持的命令列表
- 测试示例代码
- 注意事项（去除冲突警告）

---

## 🎯 功能码分配总览

### 当前功能码使用情况

| 范围 | 功能 | 状态 |
|------|------|------|
| 0x01-0x06 | I2C/SPI 配置 | 未实现 |
| 0x07-0x09 | UART | ✅ 已实现 |
| 0x0A | 数字信号测量 | ✅ 已实现 |
| 0x0B-0x10 | **保留** | - |
| 0x11 | **SPI 读写操作** | ✅ 已实现 |
| 0x12-0x1F | **保留** | - |
| **0x20-0x23** | **1-Wire 操作** | ✅ 已实现 |
| 0x24-0xFC | **保留** | - |
| 0xFD | DAC 配置 | ✅ 已实现 |
| 0xFE | PWM 配置 | ✅ 已实现 |
| 0xFF | 心跳测试 | ✅ 已实现 |

---

## 📝 校验和变化

由于功能码变化，所有命令的校验和也随之改变：

### 示例对比

#### 复位命令
```
原始: AA 55 10 00 00 0F
新版: AA 55 20 00 00 1F  (校验和 +0x10)
```

#### Skip ROM
```
原始: AA 55 14 00 01 CC 25
新版: AA 55 21 00 01 CC 31  (功能码0x14→0x21)
```

#### 读温度
```
原始: AA 55 13 00 03 01 09 BE 27
新版: AA 55 23 00 03 01 09 BE 37  (校验和 +0x10)
```

---

## 🧪 测试验证

修改完成后需要验证：

### 仿真测试
- [ ] 运行 `one_wire_master_tb.v` 验证底层时序
- [ ] 确认状态机正常工作

### 软件测试
```python
# 使用新功能码测试
python F:\FPGA2025\software\one_wire_test.py -p COM3 -t temp
```

### 集成测试
- [ ] 综合工程，检查无语法错误
- [ ] 烧录 FPGA
- [ ] 连接 DS18B20 硬件
- [ ] 读取温度验证功能

---

## ✅ 检查清单

### 代码修改
- [x] `one_wire_handler.v` - 功能码常量
- [x] 所有文档中的功能码
- [x] Python 测试脚本
- [x] 所有示例命令的校验和

### 文档更新
- [x] `USB-CDC通信协议.md` - 协议规范
- [x] `PROTOCOL.md` - 详细说明
- [x] `QUICK_REFERENCE.md` - 快速参考
- [x] `README.md` - 项目总结

### 测试准备
- [x] Python 脚本使用新功能码
- [x] 示例命令全部更新
- [x] 校验和重新计算

---

## 🎉 总结

通过将 1-Wire 功能码从 **0x10-0x13** 迁移到 **0x20-0x23**，成功解决了与 SPI 模块的功能码冲突问题。

**关键成果**：
- ✅ 功能码完全独立，无冲突
- ✅ 所有代码和文档已同步更新
- ✅ 保持 SPI 功能不变
- ✅ 为未来扩展预留空间（0x24-0x2F）

**下一步**：
按照 `INTEGRATION_GUIDE.md` 集成到 `cdc.v`，然后进行完整的功能测试。

---

**修改日期**: 2025-10-12
**修改原因**: 用户发现功能码冲突
**解决方案**: 从 0x20 开始分配 1-Wire 功能码
