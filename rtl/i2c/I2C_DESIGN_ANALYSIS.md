# I2C Handler è®¾è®¡åˆ†æä¸æ”¹è¿›å»ºè®®

## å½“å‰è®¾è®¡çŠ¶æ€

I2C handlerç°å·²é‡‡ç”¨**åŒçŠ¶æ€æœºä¸Šä¼ æ¶æ„**ï¼Œä¸UART/SPIçš„æ¶æ„**å®Œå…¨ä¸€è‡´**ã€‚

**âœ… å·²å®Œæˆå…³é”®ä¿®å¤**: upload_validä¿¡å·æ—¶åºå·²ä¿®æ­£ä¸ºå•å‘¨æœŸè„‰å†²ï¼Œæ¶ˆé™¤äº†æ•°æ®é‡å¤ä¸Šä¼ çš„é£é™©ã€‚

---

## è®¾è®¡å®ç°æ€»ç»“

### âœ… å½“å‰I2Cè®¾è®¡ç‰¹ç‚¹

1. **æ¶æ„ä¸€è‡´æ€§**
   - ä¸UART/SPIå®Œå…¨ç›¸åŒçš„åŒçŠ¶æ€æœºæ¶æ„
   - ä¸»çŠ¶æ€æœº + ç‹¬ç«‹çš„3çŠ¶æ€ä¸Šä¼ å­çŠ¶æ€æœºï¼ˆUP_IDLE, UP_SEND, UP_WAITï¼‰
   - upload_activeä¿¡å·æ­£ç¡®ï¼ˆwire + assignï¼‰

2. **æ—¶åºæ­£ç¡®æ€§**
   - upload_validä¸ºå•å‘¨æœŸè„‰å†²ï¼ˆä»…åœ¨UP_IDLEâ†’UP_SENDè½¬æ¢æ—¶ä¸ºé«˜ï¼‰
   - æ¶ˆé™¤äº†æ•°æ®é‡å¤ä¸Šä¼ çš„é£é™©
   - é€šè¿‡upload_readyæ¡æ‰‹æ§åˆ¶æ•°æ®æµ

3. **å®Œå…¨å…¼å®¹**
   - ä¸Adapterã€Packerã€Arbiterå®Œå…¨å…¼å®¹
   - éµå¾ªæ ‡å‡†çš„4é€šé“ä¸Šä¼ æµæ°´çº¿åè®®
   - ä¼˜å…ˆçº§æ­£ç¡®ï¼ˆUART > SPI > DSM > I2Cï¼‰

### ğŸ”§ å·²ä¿®å¤çš„é—®é¢˜

1. **upload_activeä¿¡å·ç±»å‹**
   - âŒ æ—§è®¾è®¡: `output reg upload_active` - åœ¨alwayså—ä¸­èµ‹å€¼
   - âœ… å½“å‰: `output wire upload_active` - ä½¿ç”¨assignè¯­å¥

2. **upload_validä¿¡å·æ—¶åº**
   - âŒ æ—§è®¾è®¡: æŒç»­ä¿æŒé«˜ç”µå¹³ï¼Œå¯èƒ½å¯¼è‡´æ•°æ®é‡å¤é‡‡æ ·
   - âœ… å½“å‰: å•å‘¨æœŸè„‰å†²ï¼Œç¡®ä¿æ¯ä¸ªæ•°æ®åªä¼ è¾“ä¸€æ¬¡

3. **çŠ¶æ€æœºæ¶æ„**
   - âŒ æ—§è®¾è®¡: ç®€åŒ–å•çŠ¶æ€æœºï¼Œä¸UART/SPIä¸ä¸€è‡´
   - âœ… å½“å‰: åŒçŠ¶æ€æœºï¼Œä¸UART/SPIå®Œå…¨ä¸€è‡´

---

## åŒçŠ¶æ€æœºæ¶æ„å®ç°è¯¦è§£

### å½“å‰å®ç°ï¼ˆå·²åº”ç”¨ï¼‰

I2C handlerç°åœ¨é‡‡ç”¨ä¸UART/SPIå®Œå…¨ä¸€è‡´çš„åŒçŠ¶æ€æœºæ¶æ„ï¼š

```verilog
// æ·»åŠ ä¸Šä¼ çŠ¶æ€æœºå®šä¹‰
localparam UP_IDLE = 2'b00;
localparam UP_SEND = 2'b01;
localparam UP_WAIT = 2'b10;

reg [1:0] upload_state;

// ä¸»çŠ¶æ€æœº
S_UPLOAD_DATA: begin
    // ä¸»çŠ¶æ€åªæ£€æŸ¥æ˜¯å¦å®Œæˆä¸Šä¼ 
    if (data_ptr_reg >= data_len_reg) begin
        state <= S_IDLE;
    end
end

// ç‹¬ç«‹çš„ä¸Šä¼ çŠ¶æ€æœº
case (upload_state)
    UP_IDLE: begin
        if ((state == S_UPLOAD_DATA) && (data_ptr_reg < data_len_reg) && upload_ready) begin
            upload_req <= 1'b1;
            upload_data <= read_buffer[data_ptr_reg];
            upload_source <= CMD_I2C_READ;
            upload_valid <= 1'b1;  // â† å•å‘¨æœŸè„‰å†²å¼€å§‹
            upload_state <= UP_SEND;
        end else begin
            upload_req <= 1'b0;
            upload_valid <= 1'b0;
        end
    end

    UP_SEND: begin
        upload_valid <= 1'b0;  // â† ç«‹å³æ‹‰ä½ï¼ˆå•å‘¨æœŸè„‰å†²ç»“æŸï¼‰
        if (upload_ready) begin
            data_ptr_reg <= data_ptr_reg + 1;
            upload_state <= UP_WAIT;
        end
    end

    UP_WAIT: begin
        upload_req <= 1'b0;
        upload_valid <= 1'b0;
        if ((state == S_UPLOAD_DATA) && (data_ptr_reg < data_len_reg) && upload_ready) begin
            upload_state <= UP_IDLE;
        end else if (data_ptr_reg >= data_len_reg) begin
            upload_state <= UP_IDLE;
        end
    end
endcase
```

**å…³é”®ç‰¹æ€§**ï¼š
- âœ… validä¿¡å·ä¸ºå•å‘¨æœŸè„‰å†²ï¼ˆä»…åœ¨UP_IDLEçŠ¶æ€æœ«å°¾ä¸ºé«˜ï¼‰
- âœ… æœ‰æ˜ç¡®çš„ç­‰å¾…å‘¨æœŸï¼ˆUP_WAITçŠ¶æ€ï¼‰
- âœ… ä¸UART/SPIå®Œå…¨ä¸€è‡´
- âœ… æ¶ˆé™¤æ•°æ®é‡å¤é£é™©

---

## æ—¶åºåˆ†æï¼šæ•°æ®ä¸é‡å¤çš„è¯æ˜

### 3å­—èŠ‚ä¸Šä¼ ç¤ºä¾‹ï¼šè¯»å–[0xAA, 0xBB, 0xCC]

| å‘¨æœŸ | upload_state | data_ptr | upload_valid | upload_data | packeré‡‡æ · | è¯´æ˜ |
|------|-------------|----------|--------------|-------------|----------|------|
| 1 | UP_IDLE | 0 | **1** | 0xAA | âœ… **é‡‡æ ·0xAA** | validé«˜ï¼Œpackeré‡‡æ ·ç¬¬1å­—èŠ‚ |
| 2 | UP_SEND | 0â†’1 | **0** | 0xAA | âŒ ä¸é‡‡æ · | validç«‹å³æ‹‰ä½ï¼ŒæŒ‡é’ˆé€’å¢ |
| 3 | UP_WAIT | 1 | 0 | 0xAA | âŒ ä¸é‡‡æ · | ç­‰å¾…çŠ¶æ€ |
| 4 | UP_IDLE | 1 | **1** | 0xBB | âœ… **é‡‡æ ·0xBB** | validå†æ¬¡é«˜ï¼Œpackeré‡‡æ ·ç¬¬2å­—èŠ‚ |
| 5 | UP_SEND | 1â†’2 | **0** | 0xBB | âŒ ä¸é‡‡æ · | validç«‹å³æ‹‰ä½ï¼ŒæŒ‡é’ˆé€’å¢ |
| 6 | UP_WAIT | 2 | 0 | 0xBB | âŒ ä¸é‡‡æ · | ç­‰å¾…çŠ¶æ€ |
| 7 | UP_IDLE | 2 | **1** | 0xCC | âœ… **é‡‡æ ·0xCC** | validå†æ¬¡é«˜ï¼Œpackeré‡‡æ ·ç¬¬3å­—èŠ‚ |
| 8 | UP_SEND | 2â†’3 | **0** | 0xCC | âŒ ä¸é‡‡æ · | validç«‹å³æ‹‰ä½ï¼ŒæŒ‡é’ˆé€’å¢ |
| 9 | UP_WAIT | 3 | 0 | 0xCC | âŒ ä¸é‡‡æ · | ç­‰å¾…çŠ¶æ€ |
| 10 | (è¿”å›S_IDLE) | 3 | 0 | - | - | ä¸Šä¼ å®Œæˆ |

**ç»“æœ**: Packeræ”¶åˆ° [0xAA, 0xBB, 0xCC] âœ… **æ­£ç¡®ï¼æ²¡æœ‰é‡å¤ï¼**

**å¯¹æ¯”æ—§è®¾è®¡çš„é—®é¢˜**ï¼ˆå·²ä¿®å¤ï¼‰ï¼š
å¦‚æœä½¿ç”¨æŒç»­é«˜ç”µå¹³çš„validä¿¡å·ï¼Œå‘¨æœŸ2å¯èƒ½å†æ¬¡é‡‡æ ·0xAAï¼Œå‘¨æœŸ5å¯èƒ½å†æ¬¡é‡‡æ ·0xBBï¼Œå‘¨æœŸ8-9å¯èƒ½é‡å¤é‡‡æ ·0xCCã€‚

---

## å…¼å®¹æ€§éªŒè¯

### upload_adapter_0.vçš„å…¼å®¹æ€§

```verilog
// Adapterçš„è¾“å…¥å¤„ç†
always @(posedge clk) begin
    if (handler_upload_active) begin
        packer_upload_req <= 1'b1;  // reqè·Ÿéšactive

        if (handler_upload_valid && handler_upload_ready) begin
            // æ¡æ‰‹æˆåŠŸæ—¶æ‰ä¼ é€’æ•°æ®
            packer_upload_data <= handler_upload_data;
        end
    end
end
```

**éªŒè¯ç»“è®º**ï¼š
- âœ… Adapteré€šè¿‡`upload_valid && upload_ready`æ¡æ‰‹æ§åˆ¶æ•°æ®æµ
- âœ… å•å‘¨æœŸè„‰å†²çš„validä¿¡å·ç¡®ä¿æ¯æ¬¡æ¡æ‰‹åªä¼ é€’ä¸€æ¬¡æ•°æ®
- âœ… I2Cçš„åŒçŠ¶æ€æœºè®¾è®¡**å®Œå…¨å…¼å®¹**

---

## ç»“è®ºä¸å»ºè®®

### âœ… å½“å‰I2C Handlerè®¾è®¡è¯„ä¼°

**è®¾è®¡è´¨é‡**: â­â­â­â­â­ ä¼˜ç§€

**è¯„ä¼°ç»“æœ**:
1. âœ… **æ¶æ„æ­£ç¡®æ€§**: é‡‡ç”¨åŒçŠ¶æ€æœºæ¶æ„ï¼Œä¸UART/SPIå®Œå…¨ä¸€è‡´
2. âœ… **æ—¶åºå®‰å…¨æ€§**: upload_validå•å‘¨æœŸè„‰å†²ï¼Œæ¶ˆé™¤æ•°æ®é‡å¤é£é™©
3. âœ… **æ¥å£å…¼å®¹æ€§**: å®Œå…¨å…¼å®¹upload_adapterã€upload_packerã€upload_arbiter
4. âœ… **ä»£ç è´¨é‡**: ç»“æ„æ¸…æ™°ï¼ŒçŠ¶æ€è½¬æ¢æ˜ç¡®ï¼Œæ˜“äºç»´æŠ¤
5. âœ… **åŠŸèƒ½å®Œæ•´æ€§**: æ”¯æŒCONFIGã€WRITEã€READä¸‰ç§æ“ä½œ

### ğŸ“‹ æµ‹è¯•éªŒè¯å»ºè®®

#### 1. ä»¿çœŸæµ‹è¯•é‡ç‚¹
```verilog
// æµ‹è¯•ç”¨ä¾‹1: å•å­—èŠ‚è¯»å–
cmd = I2C_READ, reg_addr=0x0010, len=1
é¢„æœŸ: ä¸Šä¼ 1å­—èŠ‚ï¼Œvalidä¿¡å·åªé«˜1ä¸ªå‘¨æœŸ

// æµ‹è¯•ç”¨ä¾‹2: å¤šå­—èŠ‚è¯»å–
cmd = I2C_READ, reg_addr=0x0020, len=8
é¢„æœŸ: ä¸Šä¼ 8å­—èŠ‚ï¼Œæ¯å­—èŠ‚ä¹‹é—´æœ‰UP_WAITå‘¨æœŸ

// æµ‹è¯•ç”¨ä¾‹3: æœ€å¤§é•¿åº¦è¯»å–
cmd = I2C_READ, reg_addr=0x0000, len=128
é¢„æœŸ: ä¸Šä¼ 128å­—èŠ‚ï¼Œæ— æ•°æ®é‡å¤

// æµ‹è¯•ç”¨ä¾‹4: èƒŒå‹æµ‹è¯•
åœ¨upload_ready=0æ—¶å‘èµ·è¯»å–
é¢„æœŸ: çŠ¶æ€æœºæ­£ç¡®ç­‰å¾…ï¼Œæ•°æ®ä¸ä¸¢å¤±
```

#### 2. æ³¢å½¢éªŒè¯è¦ç‚¹
- upload_validä¿¡å·å¿…é¡»ä¸ºå•å‘¨æœŸè„‰å†²ï¼ˆå®½åº¦=1ä¸ªclkï¼‰
- æ¯ä¸ªæ•°æ®å­—èŠ‚çš„ä¼ è¾“å ç”¨3ä¸ªå‘¨æœŸï¼ˆIDLE+SEND+WAITï¼‰
- upload_ready=0æ—¶ï¼ŒçŠ¶æ€æœºä¿æŒåœ¨å½“å‰çŠ¶æ€
- data_pträ»…åœ¨UP_SENDçŠ¶æ€é€’å¢

#### 3. ç¡¬ä»¶æµ‹è¯•å»ºè®®
- ä½¿ç”¨é€»è¾‘åˆ†æä»ªæ•è·upload_validå’Œupload_dataæ³¢å½¢
- éªŒè¯è¯»å–çš„æ•°æ®ä¸EEPROMå†…å®¹ä¸€è‡´
- æµ‹è¯•è¿ç»­è¯»å–æ“ä½œï¼Œç¡®è®¤æ— æ•°æ®é‡å¤
- ä¸UART/SPIåŒæ—¶ä¸Šä¼ ï¼ŒéªŒè¯arbiterä¼˜å…ˆçº§

### ğŸ“ åç»­ä¼˜åŒ–æ–¹å‘ï¼ˆå¯é€‰ï¼‰

1. **æ·»åŠ é”™è¯¯å¤„ç†**
   - æ£€æµ‹I2C NACKå“åº”
   - æ·»åŠ è¶…æ—¶ä¿æŠ¤æœºåˆ¶
   - ä¸Šä¼ é”™è¯¯çŠ¶æ€ä¿¡æ¯

2. **æ€§èƒ½ä¼˜åŒ–**
   - æ”¯æŒI2Cå¿«é€Ÿæ¨¡å¼ï¼ˆ400kHzï¼‰
   - å‡å°‘WAIT_DLYå»¶è¿Ÿæ—¶é—´
   - ä¼˜åŒ–çŠ¶æ€è½¬æ¢å‘¨æœŸ

3. **åŠŸèƒ½æ‰©å±•**
   - æ”¯æŒ8ä½åœ°å€æ¨¡å¼ï¼ˆå½“å‰å›ºå®š16ä½ï¼‰
   - æ”¯æŒå¤šä»æœºåœ°å€åˆ‡æ¢
   - æ·»åŠ è¿ç»­è¯»å†™ä¼˜åŒ–ï¼ˆä¸é‡å¤å‘é€STARTï¼‰

---

**æœ€ç»ˆç»“è®º**:

âœ… I2C handlerçš„å½“å‰è®¾è®¡æ˜¯**æ­£ç¡®ã€å®‰å…¨ã€å®Œæ•´**çš„ã€‚

- åŒçŠ¶æ€æœºæ¶æ„ç¡®ä¿äº†ä¸å…¶ä»–handlersçš„ä¸€è‡´æ€§
- å•å‘¨æœŸè„‰å†²çš„upload_validä¿¡å·æ¶ˆé™¤äº†æ•°æ®é‡å¤é£é™©
- å®Œå…¨å…¼å®¹ç°æœ‰çš„4é€šé“ä¸Šä¼ æµæ°´çº¿

**å¯ä»¥ç›´æ¥è¿›è¡Œç»¼åˆå’Œç¡¬ä»¶æµ‹è¯•ï¼Œæ— éœ€è¿›ä¸€æ­¥ä¿®æ”¹ã€‚**

---

**æ–‡æ¡£æ›´æ–°æ—¥æœŸ**: 2025-10-19
**è®¾è®¡çŠ¶æ€**: âœ… åŒçŠ¶æ€æœºæ¶æ„å·²å®ç°ï¼Œæ•°æ®é‡å¤é—®é¢˜å·²ä¿®å¤
**éªŒè¯çŠ¶æ€**: â³ å¾…ä»¿çœŸéªŒè¯å’Œç¡¬ä»¶æµ‹è¯•
